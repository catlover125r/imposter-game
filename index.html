<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Hub - Play Free Games Online</title>
    <meta name="description" content="Play free online games with friends. Imposter party game, Brasket Handom basketball, and more!">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Scanline overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.08) 2px,
                rgba(0,0,0,0.08) 4px
            );
            pointer-events: none;
            z-index: 9999;
        }

        h1, h2, h3, .retro-font {
            font-family: 'Press Start 2P', monospace;
        }

        /* Ad containers */
        .ad-wrapper {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 160px;
            min-height: 600px;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ad-left { left: 10px; }
        .ad-right { right: 10px; }
        @media (max-width: 1200px) {
            .ad-wrapper { display: none; }
        }

        .container {
            text-align: center;
            padding: 20px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .screen { display: none; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        .screen.active { display: flex; }

        /* Buttons */
        .btn {
            padding: 14px 36px;
            font-size: 1rem;
            border: 2px solid;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 180px;
            background: transparent;
        }
        .btn:hover { transform: scale(1.05); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .btn-green {
            color: #00ff41;
            border-color: #00ff41;
            text-shadow: 0 0 10px rgba(0,255,65,0.5);
            box-shadow: 0 0 15px rgba(0,255,65,0.15), inset 0 0 15px rgba(0,255,65,0.05);
        }
        .btn-green:hover {
            background: #00ff41;
            color: #0a0a0a;
            box-shadow: 0 0 30px rgba(0,255,65,0.4);
        }

        .btn-pink {
            color: #ff0066;
            border-color: #ff0066;
            text-shadow: 0 0 10px rgba(255,0,102,0.5);
            box-shadow: 0 0 15px rgba(255,0,102,0.15), inset 0 0 15px rgba(255,0,102,0.05);
        }
        .btn-pink:hover {
            background: #ff0066;
            color: #0a0a0a;
            box-shadow: 0 0 30px rgba(255,0,102,0.4);
        }

        .btn-cyan {
            color: #00d4ff;
            border-color: #00d4ff;
            text-shadow: 0 0 10px rgba(0,212,255,0.5);
            box-shadow: 0 0 15px rgba(0,212,255,0.15), inset 0 0 15px rgba(0,212,255,0.05);
        }
        .btn-cyan:hover {
            background: #00d4ff;
            color: #0a0a0a;
            box-shadow: 0 0 30px rgba(0,212,255,0.4);
        }

        .btn-small { padding: 8px 18px; font-size: 0.55rem; min-width: auto; }

        /* Back button */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: transparent;
            border: 2px solid #ff0066;
            color: #ff0066;
            width: 44px;
            height: 44px;
            border-radius: 4px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
            font-family: monospace;
            display: none;
        }
        .back-btn:hover { background: #ff0066; color: #0a0a0a; }

        /* Inputs */
        input[type="text"], input[type="number"] {
            width: 100%;
            max-width: 300px;
            padding: 14px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            border: 2px solid #00d4ff;
            border-radius: 4px;
            background: rgba(0,212,255,0.05);
            color: #00d4ff;
            text-align: center;
        }
        input::placeholder { color: rgba(0,212,255,0.4); }
        input:focus { outline: none; box-shadow: 0 0 20px rgba(0,212,255,0.3); }

        /* Game cards */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            width: 100%;
            max-width: 700px;
            margin: 30px 0;
        }
        .game-card {
            background: rgba(255,255,255,0.02);
            border: 2px solid #222;
            border-radius: 4px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .game-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            transition: all 0.3s;
        }
        .game-card:hover {
            transform: translateY(-4px);
            border-color: #444;
        }
        .game-card.imposter-card::before { background: #ff0066; }
        .game-card.imposter-card:hover { border-color: #ff0066; box-shadow: 0 0 30px rgba(255,0,102,0.15); }
        .game-card.brasket-card::before { background: #ff8800; }
        .game-card.brasket-card:hover { border-color: #ff8800; box-shadow: 0 0 30px rgba(255,136,0,0.15); }

        .game-card .card-icon { font-size: 3rem; margin-bottom: 15px; }
        .game-card h2 { font-size: 0.9rem; margin-bottom: 10px; }
        .game-card p { color: #666; font-size: 0.85rem; line-height: 1.5; }

        /* Mode buttons */
        .mode-buttons { display: flex; flex-direction: column; gap: 16px; margin: 20px 0; width: 100%; max-width: 350px; }
        .mode-btn {
            padding: 24px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
        }
        .mode-btn .icon { font-size: 2rem; margin-bottom: 5px; }
        .mode-btn .subtitle { font-size: 0.5rem; opacity: 0.6; font-family: 'Courier New', monospace; }

        /* Side select buttons */
        .side-select { display: flex; gap: 16px; margin: 10px 0; }
        .side-btn {
            padding: 16px 30px;
            border: 2px solid #333;
            border-radius: 4px;
            background: transparent;
            color: #888;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .side-btn.selected { border-color: #ff8800; color: #ff8800; box-shadow: 0 0 15px rgba(255,136,0,0.2); }
        .side-btn:hover { border-color: #666; color: #ccc; }

        /* Room code display */
        .room-code {
            background: rgba(0,255,65,0.05);
            border: 2px solid #00ff41;
            padding: 16px 32px;
            border-radius: 4px;
            font-family: 'Press Start 2P', monospace;
            font-size: 1.8rem;
            letter-spacing: 8px;
            color: #00ff41;
            text-shadow: 0 0 20px rgba(0,255,65,0.5);
        }

        /* Player list */
        .player-list {
            width: 100%;
            max-width: 350px;
            border: 1px solid #222;
            border-radius: 4px;
            padding: 16px;
            margin: 10px 0;
        }
        .player-list h3 { color: #00d4ff; font-size: 0.6rem; margin-bottom: 12px; }
        .player-item {
            padding: 10px 12px;
            margin: 6px 0;
            background: rgba(255,255,255,0.02);
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        .player-item.host::before { content: '>>'; color: #ff8800; margin-right: 4px; font-weight: bold; }
        .player-item.you { border-color: #00ff41; }

        /* Voting UI */
        .vote-player-item {
            padding: 10px 12px;
            margin: 6px 0;
            background: rgba(255,255,255,0.02);
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .vote-player-item.you { border-color: #00ff41; }
        .vote-player-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .vote-player-name { font-weight: bold; }
        .vote-count {
            background: #ff0066;
            color: #0a0a0a;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 0.85rem;
            min-width: 24px;
            text-align: center;
            font-weight: bold;
        }
        .vote-btn {
            padding: 6px 14px;
            font-size: 0.5rem;
            font-family: 'Press Start 2P', monospace;
            background: transparent;
            border: 1px solid #ff0066;
            color: #ff0066;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .vote-btn:hover:not(:disabled) { background: #ff0066; color: #0a0a0a; }
        .vote-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .vote-btn.voted { background: #00ff41; border-color: #00ff41; color: #0a0a0a; }
        .your-vote-label { color: #00ff41; font-size: 0.75rem; margin-left: 4px; }

        /* Role card */
        .role-card {
            border: 2px solid #333;
            border-radius: 4px;
            padding: 30px;
            margin: 15px 0;
            min-width: 260px;
            background: rgba(255,255,255,0.02);
        }
        .role-card.imposter { border-color: #ff0066; box-shadow: 0 0 30px rgba(255,0,102,0.2); }
        .role-card.crewmate { border-color: #00ff41; box-shadow: 0 0 30px rgba(0,255,65,0.2); }
        .role-label { font-size: 0.9rem; color: #666; margin-bottom: 8px; }
        .role-text { font-size: 1.4rem; font-weight: bold; font-family: 'Press Start 2P', monospace; }
        .role-card.imposter .role-text { color: #ff0066; text-shadow: 0 0 20px rgba(255,0,102,0.5); }
        .role-card.crewmate .role-text { color: #00ff41; text-shadow: 0 0 20px rgba(0,255,65,0.5); }

        /* Result card */
        .result-card {
            border: 2px solid #333;
            border-radius: 4px;
            padding: 24px;
            margin: 15px 0;
            min-width: 260px;
            background: rgba(255,255,255,0.02);
        }
        .result-card.caught { border-color: #00ff41; box-shadow: 0 0 30px rgba(0,255,65,0.2); }
        .result-card.escaped { border-color: #ff0066; box-shadow: 0 0 30px rgba(255,0,102,0.2); }
        .result-label { font-size: 0.85rem; color: #666; margin-bottom: 8px; }
        .result-name { font-size: 1.2rem; font-weight: bold; color: #ff0066; margin-bottom: 8px; font-family: 'Press Start 2P', monospace; }
        .result-word { font-size: 1rem; color: #00ff41; margin-bottom: 12px; }
        .result-message { font-size: 0.9rem; font-weight: bold; }
        .result-card.caught .result-message { color: #00ff41; }
        .result-card.escaped .result-message { color: #ff0066; }

        /* Word editor */
        .word-editor-section { width: 100%; max-width: 400px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #1a1a1a; }
        .word-textarea {
            width: 100%;
            height: 120px;
            background: rgba(0,212,255,0.03);
            border: 1px solid #222;
            border-radius: 4px;
            color: #00d4ff;
            font-size: 0.9rem;
            padding: 12px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        .word-textarea::placeholder { color: #333; }
        .word-textarea:focus { outline: none; border-color: #00d4ff; }
        .word-count { margin-top: 6px; color: #444; font-size: 0.8rem; }

        /* Player boxes (single device imposter) */
        .player-boxes { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 20px; }
        .player-box {
            width: 80px;
            height: 80px;
            border: 2px solid #ff0066;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            color: #ff0066;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
        }
        .player-box:hover:not(.revealed) { box-shadow: 0 0 20px rgba(255,0,102,0.4); transform: scale(1.05); }
        .player-box.revealed { border-color: #222; color: #333; cursor: default; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #0a0a0a;
            border: 2px solid #ff0066;
            padding: 40px;
            border-radius: 4px;
            text-align: center;
            max-width: 90%;
        }
        .modal .role-text { font-size: 1.4rem; margin-bottom: 24px; }

        /* Status text */
        .status { color: #444; font-size: 0.9rem; margin: 8px 0; }
        .status.waiting { animation: blink 1.5s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .error { color: #ff0066; font-size: 0.9rem; margin: 8px 0; }
        .or-text { color: #333; margin: 8px 0; font-family: 'Press Start 2P', monospace; font-size: 0.5rem; }

        /* Misc */
        .instructions { color: #444; font-size: 0.8rem; margin-top: 8px; line-height: 1.6; }
        .vote-instruction { color: #444; font-size: 0.8rem; margin-bottom: 8px; }
        .button-row { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        .end-buttons { display: none; margin-top: 20px; gap: 12px; justify-content: center; flex-wrap: wrap; }

        /* Game canvas container */
        .game-canvas-wrap {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 8/5;
            border: 2px solid #ff8800;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            background: #1a0a00;
        }
        .game-canvas-wrap canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Iframe game container */
        .iframe-wrap {
            width: 100%;
            max-width: 900px;
            aspect-ratio: 4/3;
            border: 2px solid #ff8800;
            border-radius: 4px;
            overflow: hidden;
        }
        .iframe-wrap iframe { width: 100%; height: 100%; border: none; }

        #brGameVideo {
            width: 100%;
            max-width: 900px;
            border: 2px solid #ff8800;
            border-radius: 4px;
            background: #000;
            display: none;
        }

        /* Control hints */
        .control-hints {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin: 10px 0;
        }
        .control-hint {
            font-size: 0.8rem;
            color: #666;
        }
        .control-hint kbd {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 2px 8px;
            border-radius: 3px;
            color: #ff8800;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.5rem;
        }

        /* Footer */
        .footer {
            margin-top: 40px;
            padding-top: 16px;
            border-top: 1px solid #111;
        }
        .footer a { color: #333; text-decoration: none; font-size: 0.75rem; transition: color 0.2s; }
        .footer a:hover { color: #666; }

        /* Title glow */
        .title-glow {
            font-size: 1.5rem;
            color: #00ff41;
            text-shadow: 0 0 30px rgba(0,255,65,0.4), 0 0 60px rgba(0,255,65,0.1);
            margin-bottom: 8px;
        }
        .subtitle { color: #444; font-size: 0.5rem; font-family: 'Press Start 2P', monospace; letter-spacing: 3px; }

        /* Score display for brasket */
        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            font-family: 'Press Start 2P', monospace;
            margin: 10px 0;
        }
        .score-left { color: #00d4ff; font-size: 1.5rem; text-shadow: 0 0 15px rgba(0,212,255,0.5); }
        .score-sep { color: #333; font-size: 1rem; }
        .score-right { color: #ff8800; font-size: 1.5rem; text-shadow: 0 0 15px rgba(255,136,0,0.5); }

        /* Modifier announcement */
        .modifier-announce {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Press Start 2P', monospace;
            font-size: 1rem;
            color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.8);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .modifier-announce.show { opacity: 1; }

        @media (max-width: 600px) {
            .title-glow { font-size: 1rem; }
            .game-grid { grid-template-columns: 1fr; }
            .game-card h2 { font-size: 0.7rem; }
            .btn { font-size: 0.55rem; padding: 12px 24px; min-width: 150px; }
            .room-code { font-size: 1.3rem; padding: 12px 20px; }
        }
    </style>
</head>
<body>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1190255474469820" crossorigin="anonymous"></script>

    <!-- Left Ad -->
    <div class="ad-wrapper ad-left">
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1190255474469820" data-ad-slot="5870859418" data-ad-format="vertical" data-full-width-responsive="false"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>

    <!-- Right Ad -->
    <div class="ad-wrapper ad-right">
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1190255474469820" data-ad-slot="5870859418" data-ad-format="vertical" data-full-width-responsive="false"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>

    <div class="container">

        <!-- ========== LANDING PAGE ========== -->
        <div class="screen active" id="landingScreen">
            <h1 class="title-glow">GAME HUB</h1>
            <p class="subtitle">SELECT A GAME</p>

            <div class="game-grid">
                <div class="game-card imposter-card" onclick="showScreen('impModeScreen')">
                    <div class="card-icon">?!</div>
                    <h2 style="color:#ff0066">IMPOSTER</h2>
                    <p>Social deduction party game. One player is the imposter &mdash; can your group find them?</p>
                </div>
                <div class="game-card brasket-card" onclick="showScreen('brModeScreen')">
                    <div class="card-icon">//</div>
                    <h2 style="color:#ff8800">BRASKET HANDOM</h2>
                    <p>Chaotic basketball with random physics. Play on one device or online with a friend!</p>
                </div>
            </div>

            <div class="footer">
                <a href="#" onclick="showScreen('privacyScreen'); return false;">Privacy Policy</a>
            </div>
        </div>

        <!-- ========== PRIVACY (minimal) ========== -->
        <div class="screen" id="privacyScreen">
            <button class="back-btn" onclick="showScreen('landingScreen')">&#8592;</button>
            <h2 style="color:#666; font-size:0.7rem;">Privacy Policy</h2>
            <div style="max-width:500px; text-align:left; color:#555; font-size:0.8rem; line-height:1.7; margin-top:16px;">
                <p>We collect no personal data. Display names and game data are temporary and deleted when you leave. We use Google Firebase for multiplayer and Google AdSense for ads. See <a href="https://policies.google.com/privacy" style="color:#00d4ff;" target="_blank">Google's Privacy Policy</a> for details.</p>
                <p style="margin-top:12px;">Contact: <span style="color:#00d4ff;">contact@secretimposter.com</span></p>
            </div>
        </div>

        <!-- ========== IMPOSTER: MODE SELECT ========== -->
        <div class="screen" id="impModeScreen">
            <button class="back-btn" onclick="showScreen('landingScreen')">&#8592;</button>
            <h1 style="color:#ff0066; font-size:1.2rem;">IMPOSTER</h1>
            <p style="color:#444; font-size:0.8rem;">Choose your game mode</p>
            <div class="mode-buttons">
                <button class="btn btn-pink mode-btn" onclick="selectImpMode('single')">
                    <span class="icon">1</span><span>One Device</span><span class="subtitle">Pass the phone around</span>
                </button>
                <button class="btn btn-green mode-btn" onclick="selectImpMode('multi')">
                    <span class="icon">+++</span><span>Multiple Devices</span><span class="subtitle">Everyone on their own phone</span>
                </button>
            </div>
        </div>

        <!-- IMPOSTER: Single device lobby -->
        <div class="screen" id="singleLobbyScreen">
            <button class="back-btn" onclick="showScreen('impModeScreen')">&#8592;</button>
            <h1 style="color:#ff0066; font-size:1rem;">ONE DEVICE</h1>
            <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
                <label style="font-size:0.9rem; color:#888;">Number of Players:</label>
                <input type="number" id="singlePlayerCount" min="3" max="20" value="4" style="width:80px; height:50px; font-size:1.5rem;">
            </div>
            <button class="btn btn-pink" onclick="startSingleGame()">PLAY</button>
            <button class="btn btn-cyan btn-small" onclick="toggleSingleWordEditor()" id="singleEditBtn">EDIT WORDS</button>
            <div class="word-editor-section" id="singleWordEditorSection" style="display:none;">
                <p style="color:#444; font-size:0.8rem; margin-bottom:8px;">One word per line or comma-separated</p>
                <textarea class="word-textarea" id="singleWordTextarea" placeholder="Enter words..."></textarea>
                <div class="word-count" id="singleWordCount">0 words</div>
                <div class="button-row" style="margin-top:8px;">
                    <button class="btn btn-cyan btn-small" onclick="resetWordsSingle()">RESET</button>
                    <button class="btn btn-green btn-small" onclick="toggleSingleWordEditor()">DONE</button>
                </div>
            </div>
            <p class="instructions">Each player taps a box to see their role. One person is the IMPOSTER!</p>
        </div>

        <!-- IMPOSTER: Single device game -->
        <div class="screen" id="singleGameScreen">
            <h2 style="color:#ff0066; font-size:0.8rem;">TAP YOUR BOX</h2>
            <div class="player-boxes" id="singlePlayerBoxes"></div>
            <div class="end-buttons" id="singleEndButtons">
                <button class="btn btn-cyan" onclick="newSingleRound()">NEW ROUND</button>
                <button class="btn btn-pink" onclick="showScreen('singleLobbyScreen')">LOBBY</button>
            </div>
        </div>

        <div class="modal" id="singleModal">
            <div class="modal-content">
                <div class="role-text" id="singleRoleText"></div>
                <button class="btn btn-green" onclick="closeSingleModal()">OK</button>
            </div>
        </div>

        <!-- IMPOSTER: Multi menu -->
        <div class="screen" id="multiMenuScreen">
            <button class="back-btn" onclick="showScreen('impModeScreen')">&#8592;</button>
            <h1 style="color:#ff0066; font-size:1rem;">MULTIPLAYER</h1>
            <input type="text" id="playerName" placeholder="Your name" maxlength="15">
            <button class="btn btn-pink" onclick="createRoom()">CREATE ROOM</button>
            <div class="or-text">-- or --</div>
            <input type="text" id="joinCode" placeholder="Room code" maxlength="6" style="text-transform:uppercase;">
            <button class="btn btn-green" onclick="joinRoom()">JOIN ROOM</button>
            <p class="error" id="menuError"></p>
        </div>

        <!-- IMPOSTER: Multi lobby -->
        <div class="screen" id="multiLobbyScreen">
            <h2 style="color:#ff0066; font-size:0.8rem;">LOBBY</h2>
            <p style="color:#666; font-size:0.8rem;">Room Code:</p>
            <div class="room-code" id="displayRoomCode">----</div>
            <div class="player-list"><h3>Players</h3><div id="playerListContainer"></div></div>
            <button class="btn btn-pink" id="startGameBtn" onclick="startMultiGame()" style="display:none;">START GAME</button>
            <p class="status waiting" id="lobbyStatus">Waiting for host...</p>
            <button class="btn btn-cyan btn-small" onclick="toggleMultiWordEditor()" id="multiEditBtn">EDIT WORDS</button>
            <div class="word-editor-section" id="multiWordEditorSection" style="display:none;">
                <p style="color:#444; font-size:0.8rem; margin-bottom:8px;">One word per line or comma-separated</p>
                <textarea class="word-textarea" id="multiWordTextarea" placeholder="Enter words..."></textarea>
                <div class="word-count" id="multiWordCount">0 words</div>
                <div class="button-row" style="margin-top:8px;">
                    <button class="btn btn-cyan btn-small" onclick="resetWordsMulti()">RESET</button>
                    <button class="btn btn-green btn-small" onclick="saveWordsMulti()">SAVE</button>
                </div>
            </div>
            <button class="btn btn-pink btn-small" onclick="leaveRoom()" style="margin-top:16px;">LEAVE</button>
        </div>

        <!-- IMPOSTER: Multi game -->
        <div class="screen" id="multiGameScreen">
            <h2 id="roleTitle" style="color:#ff0066; font-size:0.8rem;">YOUR ROLE</h2>
            <div class="role-card" id="roleCard">
                <div class="role-label" id="roleLabel">You are:</div>
                <div class="role-text" id="multiRoleText">Loading...</div>
            </div>
            <p class="vote-instruction">Vote for who you think is the imposter!</p>
            <div class="player-list"><h3>VOTE</h3><div id="votePlayerList"></div></div>
            <p class="status" id="voteStatus">Waiting for votes...</p>
        </div>

        <!-- IMPOSTER: Multi end -->
        <div class="screen" id="multiEndScreen">
            <h2 style="color:#ff0066; font-size:0.8rem;">RESULTS</h2>
            <div class="result-card" id="resultCard">
                <div class="result-label">The imposter was:</div>
                <div class="result-name" id="resultName">???</div>
                <div class="result-word" id="resultWord"></div>
                <div class="result-message" id="resultMessage">???</div>
            </div>
            <div class="player-list"><h3>Final Votes</h3><div id="endPlayerList"></div></div>
            <button class="btn btn-cyan" id="newRoundBtn" onclick="newMultiRound()" style="display:none;">NEW ROUND</button>
            <button class="btn btn-pink" id="backToLobbyBtn" onclick="backToMultiLobby()" style="display:none;">LOBBY</button>
            <button class="btn btn-pink btn-small" id="leaveRoomEndBtn" onclick="leaveRoom()" style="display:none;">LEAVE</button>
            <p class="status waiting" id="endStatus">Waiting for host...</p>
        </div>

        <!-- ========== BRASKET HANDOM: MODE SELECT ========== -->
        <div class="screen" id="brModeScreen">
            <button class="back-btn" onclick="showScreen('landingScreen')">&#8592;</button>
            <h1 style="color:#ff8800; font-size:1rem;">BRASKET HANDOM</h1>
            <p style="color:#444; font-size:0.8rem;">How do you want to play?</p>
            <div class="mode-buttons">
                <button class="btn btn-cyan mode-btn" style="border-color:#ff8800; color:#ff8800;" onclick="showScreen('brLocalSetup')">
                    <span class="icon">1</span><span>On Device</span><span class="subtitle">Play on this device</span>
                </button>
                <button class="btn btn-green mode-btn" style="border-color:#ff8800; color:#ff8800;" onclick="showScreen('brOnlineMenu')">
                    <span class="icon">@</span><span>Online</span><span class="subtitle">Play with a friend remotely</span>
                </button>
            </div>
        </div>

        <!-- BRASKET: Local setup -->
        <div class="screen" id="brLocalSetup">
            <button class="back-btn" onclick="showScreen('brModeScreen')">&#8592;</button>
            <h2 style="color:#ff8800; font-size:0.8rem;">ON DEVICE</h2>

            <p style="color:#888; font-size:0.8rem;">Players:</p>
            <div class="side-select" id="brPlayerCountSelect">
                <button class="side-btn selected" onclick="brSetPlayerCount(1)" id="br1PBtn">1 PLAYER</button>
                <button class="side-btn" onclick="brSetPlayerCount(2)" id="br2PBtn">2 PLAYERS</button>
            </div>

            <p style="color:#888; font-size:0.8rem;" id="brSideLabel">Your side:</p>
            <div class="side-select" id="brSideSelect">
                <button class="side-btn selected" onclick="brSetSide('left')" id="brLeftBtn">LEFT</button>
                <button class="side-btn" onclick="brSetSide('right')" id="brRightBtn">RIGHT</button>
            </div>

            <button class="btn btn-green" style="border-color:#ff8800; color:#ff8800; margin-top:10px;" onclick="startBrLocal()">START</button>

            <div class="control-hints" style="margin-top:16px;">
                <span class="control-hint">Left: <kbd>W</kbd></span>
                <span class="control-hint">Right: <kbd>UP</kbd></span>
            </div>
        </div>

        <!-- BRASKET: Local game -->
        <div class="screen" id="brLocalGame">
            <button class="back-btn" onclick="exitBrLocal()">&#8592;</button>
            <div class="iframe-wrap" id="brIframeWrap">
                <iframe id="brIframe" src="" allowfullscreen></iframe>
            </div>
            <div class="control-hints">
                <span class="control-hint">Left player: <kbd>W</kbd></span>
                <span class="control-hint">Right player: <kbd>UP</kbd></span>
            </div>
            <button class="btn btn-pink btn-small" onclick="exitBrLocal()" style="margin-top:8px;">EXIT</button>
        </div>

        <!-- BRASKET: Online menu -->
        <div class="screen" id="brOnlineMenu">
            <button class="back-btn" onclick="showScreen('brModeScreen')">&#8592;</button>
            <h2 style="color:#ff8800; font-size:0.8rem;">ONLINE</h2>

            <input type="text" id="brPlayerName" placeholder="Your name" maxlength="15" style="border-color:#ff8800; color:#ff8800; background:rgba(255,136,0,0.05);">

            <button class="btn btn-green" style="border-color:#ff8800; color:#ff8800;" onclick="brCreateRoom()">CREATE ROOM</button>
            <div class="or-text">-- or --</div>
            <input type="text" id="brJoinCode" placeholder="Room code" maxlength="6" style="text-transform:uppercase; border-color:#ff8800; color:#ff8800; background:rgba(255,136,0,0.05);">
            <button class="btn btn-cyan" style="border-color:#ff8800; color:#ff8800;" onclick="brJoinRoom()">JOIN ROOM</button>

            <p style="color:#888; font-size:0.8rem; margin-top:12px;">Your side:</p>
            <div class="side-select">
                <button class="side-btn selected" onclick="brOnlineSetSide('left')" id="brOnLeftBtn">LEFT</button>
                <button class="side-btn" onclick="brOnlineSetSide('right')" id="brOnRightBtn">RIGHT</button>
            </div>

            <p class="error" id="brMenuError"></p>
        </div>

        <!-- BRASKET: Online lobby -->
        <div class="screen" id="brOnlineLobby">
            <h2 style="color:#ff8800; font-size:0.8rem;">LOBBY</h2>
            <p style="color:#666; font-size:0.8rem;">Room Code:</p>
            <div class="room-code" style="border-color:#ff8800; color:#ff8800; background:rgba(255,136,0,0.05); text-shadow:0 0 20px rgba(255,136,0,0.5);" id="brDisplayRoomCode">----</div>
            <div class="player-list" id="brPlayerListWrap">
                <h3 style="color:#ff8800;">Players</h3>
                <div id="brPlayerListContainer"></div>
            </div>
            <button class="btn btn-green" style="border-color:#ff8800; color:#ff8800;" id="brStartBtn" onclick="brStartOnlineGame()" style="display:none;">START</button>
            <p class="status waiting" id="brLobbyStatus">Waiting for opponent...</p>
            <button class="btn btn-pink btn-small" onclick="brLeaveRoom()">LEAVE</button>
        </div>

        <!-- BRASKET: Online game -->
        <div class="screen" id="brOnlineGame">
            <div class="iframe-wrap" id="brOnlineIframeWrap" style="display:none;">
                <iframe id="brGameIframe" allowfullscreen></iframe>
            </div>
            <video id="brGameVideo" autoplay playsinline></video>
            <p class="status waiting" id="brOnlineConnStatus">Setting up connection...</p>
            <div class="control-hints" id="brOnlineHints">
                <span class="control-hint">Left player: <kbd>W</kbd></span>
                <span class="control-hint">Right player: <kbd>UP</kbd></span>
            </div>
            <p style="color:#888; font-size:0.65rem; margin-top:4px;" id="brOnlineTip"></p>
            <button class="btn btn-pink btn-small" onclick="brLeaveOnlineGame()" style="margin-top:8px;">LEAVE</button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
    // ============================================================
    // FIREBASE INIT
    // ============================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAOsYfd3vBVUzHqysG_oXPKi7yXrI-hVrE",
        authDomain: "imposter-game-777f3.firebaseapp.com",
        databaseURL: "https://imposter-game-777f3-default-rtdb.firebaseio.com",
        projectId: "imposter-game-777f3",
        storageBucket: "imposter-game-777f3.firebasestorage.app",
        messagingSenderId: "791197389028",
        appId: "1:791197389028:web:72282811d5e08040a7dcf1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ============================================================
    // NAVIGATION
    // ============================================================
    let currentScreen = 'landingScreen';

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.back-btn').forEach(b => b.style.display = 'none');
        const bb = document.getElementById(id).querySelector('.back-btn');
        if (bb) bb.style.display = 'block';
        currentScreen = id;
    }

    // ============================================================
    // IMPOSTER GAME (preserved logic)
    // ============================================================
    const defaultWords = ["Pizza","Coffee","Sushi","Hamburger","Ice cream","Chocolate","Sandwich","Pasta","Cookies","Bacon","Elephant","Dolphin","Penguin","Giraffe","Octopus","Butterfly","Tiger","Kangaroo","Shark","Eagle","Umbrella","Backpack","Sunglasses","Headphones","Flashlight","Wallet","Pillow","Camera","Skateboard","Guitar","Beach","Library","Restaurant","Airport","Stadium","Hospital","Museum","Gym","Theater","Park","Swimming","Dancing","Cooking","Reading","Painting","Camping","Shopping","Singing","Jogging","Gaming","Teacher","Doctor","Chef","Firefighter","Pilot","Artist","Scientist","Musician","Athlete","Photographer"];

    let singleModeWords = [...defaultWords];
    let multiModeWords = [...defaultWords];
    let singleWordQueue = [];
    let multiWordQueue = [];

    function shuffleArray(arr) { const s=[...arr]; for(let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[s[i],s[j]]=[s[j],s[i]];} return s; }
    function getNextSingleWord() { if(!singleWordQueue.length) singleWordQueue=shuffleArray(singleModeWords); return singleWordQueue.pop(); }
    function getNextMultiWord(wl) { if(!multiWordQueue.length) multiWordQueue=shuffleArray(wl); return multiWordQueue.pop(); }
    function parseWordsFromText(t) { return t.split(/[,\n]+/).map(w=>w.trim()).filter(w=>w.length>0); }
    function wordsToText(a) { return a.join('\n'); }
    function updateSingleWordCount() { const t=document.getElementById('singleWordTextarea'); if(t) document.getElementById('singleWordCount').textContent=parseWordsFromText(t.value).length+' words'; }
    function updateMultiWordCount() { const t=document.getElementById('multiWordTextarea'); if(t) document.getElementById('multiWordCount').textContent=parseWordsFromText(t.value).length+' words'; }

    function updateSingleWords() {
        const t=document.getElementById('singleWordTextarea');
        singleModeWords=parseWordsFromText(t.value);
        if(!singleModeWords.length){singleModeWords=[...defaultWords];t.value=wordsToText(singleModeWords);}
        singleWordQueue=[];
        updateSingleWordCount();
    }
    function resetWordsSingle() { singleModeWords=[...defaultWords]; singleWordQueue=[]; document.getElementById('singleWordTextarea').value=wordsToText(singleModeWords); updateSingleWordCount(); }
    async function saveWordsMulti() {
        const t=document.getElementById('multiWordTextarea');
        multiModeWords=parseWordsFromText(t.value);
        if(!multiModeWords.length){multiModeWords=[...defaultWords];t.value=wordsToText(multiModeWords);}
        multiWordQueue=[];
        updateMultiWordCount();
        if(roomRef) await roomRef.child('words').set(multiModeWords);
    }
    async function resetWordsMulti() { multiModeWords=[...defaultWords]; multiWordQueue=[]; document.getElementById('multiWordTextarea').value=wordsToText(multiModeWords); updateMultiWordCount(); if(roomRef) await roomRef.child('words').set(multiModeWords); }
    function initSingleWordEditor() { singleModeWords=[...defaultWords]; singleWordQueue=[]; const t=document.getElementById('singleWordTextarea'); if(t){t.value=wordsToText(singleModeWords);updateSingleWordCount();} }
    function initMultiWordEditor() { const t=document.getElementById('multiWordTextarea'); if(t){t.value=wordsToText(multiModeWords);updateMultiWordCount();} }
    function toggleSingleWordEditor() { const s=document.getElementById('singleWordEditorSection'); s.style.display=s.style.display==='none'?'block':'none'; }
    function toggleMultiWordEditor() { const s=document.getElementById('multiWordEditorSection'); s.style.display=s.style.display==='none'?'block':'none'; }

    function selectImpMode(mode) { if(mode==='single'){showScreen('singleLobbyScreen');initSingleWordEditor();}else{showScreen('multiMenuScreen');} }

    // Single device game
    let singlePlayerCount=4, singleImposterIndex=0, singleCurrentWord="", singleRevealedCount=0, singleCurrentBoxIndex=-1;

    function startSingleGame() {
        updateSingleWords();
        singlePlayerCount=Math.min(20,Math.max(3,parseInt(document.getElementById('singlePlayerCount').value)));
        setupSingleRound();
        showScreen('singleGameScreen');
    }
    function setupSingleRound() {
        singleImposterIndex=Math.floor(Math.random()*singlePlayerCount);
        singleCurrentWord=getNextSingleWord();
        singleRevealedCount=0;
        const c=document.getElementById('singlePlayerBoxes'); c.innerHTML='';
        for(let i=0;i<singlePlayerCount;i++){
            const b=document.createElement('div'); b.className='player-box'; b.textContent='P'+(i+1);
            b.onclick=()=>revealSingleRole(i); c.appendChild(b);
        }
        document.getElementById('singleEndButtons').style.display='none';
    }
    function revealSingleRole(i) {
        const boxes=document.querySelectorAll('#singlePlayerBoxes .player-box');
        if(boxes[i].classList.contains('revealed')) return;
        singleCurrentBoxIndex=i;
        const rt=document.getElementById('singleRoleText');
        if(i===singleImposterIndex){rt.textContent='IMPOSTER';rt.className='role-text imposter';}
        else{rt.textContent=singleCurrentWord;rt.className='role-text crewmate';}
        document.getElementById('singleModal').style.display='flex';
    }
    function closeSingleModal() {
        document.getElementById('singleModal').style.display='none';
        const boxes=document.querySelectorAll('#singlePlayerBoxes .player-box');
        boxes[singleCurrentBoxIndex].classList.add('revealed'); boxes[singleCurrentBoxIndex].textContent='OK';
        singleRevealedCount++;
        if(singleRevealedCount===singlePlayerCount) document.getElementById('singleEndButtons').style.display='flex';
    }
    function newSingleRound() { setupSingleRound(); }

    // Multiplayer
    let playerId=null, playerName='', roomCode=null, isHost=false, roomRef=null;
    function generatePlayerId() { return 'p_'+Math.random().toString(36).substr(2,9); }
    function generateRoomCode() { const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r=''; for(let i=0;i<4;i++) r+=c.charAt(Math.floor(Math.random()*c.length)); return r; }

    async function createRoom() {
        playerName=document.getElementById('playerName').value.trim();
        if(!playerName){document.getElementById('menuError').textContent='Enter your name!';return;}
        playerId=generatePlayerId(); roomCode=generateRoomCode(); isHost=true;
        roomRef=db.ref('rooms/'+roomCode);
        const snap=await roomRef.once('value');
        if(snap.exists()){roomCode=generateRoomCode();roomRef=db.ref('rooms/'+roomCode);}
        multiModeWords=[...defaultWords];
        await roomRef.set({host:playerId,status:'lobby',players:{[playerId]:{name:playerName,isHost:true}},gameData:null,words:multiModeWords,createdAt:firebase.database.ServerValue.TIMESTAMP});
        roomRef.child('players/'+playerId).onDisconnect().remove();
        setupRoomListeners();
        document.getElementById('displayRoomCode').textContent=roomCode;
        document.getElementById('startGameBtn').style.display='block';
        document.getElementById('lobbyStatus').style.display='none';
        initMultiWordEditor();
        showScreen('multiLobbyScreen');
    }

    async function joinRoom() {
        playerName=document.getElementById('playerName').value.trim();
        const code=document.getElementById('joinCode').value.trim().toUpperCase();
        if(!playerName){document.getElementById('menuError').textContent='Enter your name!';return;}
        if(!code||code.length!==4){document.getElementById('menuError').textContent='Enter a valid 4-letter code!';return;}
        roomCode=code; roomRef=db.ref('rooms/'+roomCode);
        const snap=await roomRef.once('value');
        if(!snap.exists()){document.getElementById('menuError').textContent='Room not found!';return;}
        const rd=snap.val();
        if(rd.status!=='lobby'){document.getElementById('menuError').textContent='Game already started!';return;}
        playerId=generatePlayerId(); isHost=false;
        multiModeWords=rd.words||[...defaultWords];
        await roomRef.child('players/'+playerId).set({name:playerName,isHost:false});
        roomRef.child('players/'+playerId).onDisconnect().remove();
        setupRoomListeners();
        document.getElementById('displayRoomCode').textContent=roomCode;
        document.getElementById('startGameBtn').style.display='none';
        document.getElementById('lobbyStatus').style.display='block';
        initMultiWordEditor();
        showScreen('multiLobbyScreen');
    }

    function setupRoomListeners() {
        roomRef.on('value',(snap)=>{
            if(!snap.exists()){alert('Room closed!');showScreen('multiMenuScreen');roomRef=null;return;}
            const data=snap.val();
            if(data.words&&Array.isArray(data.words)){multiModeWords=data.words;const t=document.getElementById('multiWordTextarea');if(t&&currentScreen==='multiLobbyScreen'){t.value=wordsToText(multiModeWords);updateMultiWordCount();}}
            if(data.host===playerId) isHost=true;
            updateLobbyPlayerList(data.players);
            if(data.status==='playing'&&(currentScreen==='multiLobbyScreen'||currentScreen==='multiEndScreen')) showMultiGameScreen(data);
            else if(data.status==='playing'&&currentScreen==='multiGameScreen') updateVotingUI(data);
            else if(data.status==='results'&&currentScreen==='multiGameScreen') showMultiEndScreen(data);
            else if(data.status==='lobby'&&(currentScreen==='multiEndScreen'||currentScreen==='multiGameScreen')) showMultiLobbyFromEnd(data);
            if(currentScreen==='multiEndScreen') updateEndScreenButtons();
        });
    }

    function updateLobbyPlayerList(players) {
        const c=document.getElementById('playerListContainer'); if(!c)return; c.innerHTML='';
        for(const[id,p]of Object.entries(players||{})){
            const d=document.createElement('div'); d.className='player-item';
            if(p.isHost) d.classList.add('host'); if(id===playerId) d.classList.add('you');
            d.textContent=p.name+(id===playerId?' (You)':''); c.appendChild(d);
        }
        const cnt=Object.keys(players||{}).length;
        const btn=document.getElementById('startGameBtn');
        if(btn&&isHost){btn.disabled=cnt<3;btn.textContent=cnt<3?'NEED 3+':'START GAME';}
    }

    async function startMultiGame() {
        if(!isHost)return;
        const snap=await roomRef.once('value');const data=snap.val();
        const pids=Object.keys(data.players);
        if(pids.length<3){alert('Need 3+ players!');return;}
        const impIdx=Math.floor(Math.random()*pids.length);
        const impId=pids[impIdx];
        const gw=data.words||multiModeWords;
        const word=getNextMultiWord(gw);
        const roles={},votes={};
        pids.forEach(id=>{roles[id]={isImposter:id===impId,word:id===impId?null:word};votes[id]=null;});
        await roomRef.update({gameData:{roles,word,imposterId:impId,votes},status:'playing'});
    }

    function showMultiGameScreen(data) {
        const my=data.gameData.roles[playerId];
        const rc=document.getElementById('roleCard'),rt=document.getElementById('multiRoleText');
        const title=document.getElementById('roleTitle'),label=document.getElementById('roleLabel');
        if(my.isImposter){rc.className='role-card imposter';rt.textContent='IMPOSTER';title.textContent='YOUR ROLE';label.style.display='block';label.textContent='You are:';}
        else{rc.className='role-card crewmate';rt.textContent=my.word;title.textContent='YOUR WORD';label.style.display='none';}
        updateVotingUI(data);
        showScreen('multiGameScreen');
    }

    function updateVotingUI(data) {
        const c=document.getElementById('votePlayerList'); if(!c)return; c.innerHTML='';
        const players=data.players,votes=data.gameData.votes||{};
        const pids=Object.keys(players),total=pids.length;
        const vc={}; pids.forEach(id=>vc[id]=0);
        for(const[vid,vfor]of Object.entries(votes)){if(vfor&&vc.hasOwnProperty(vfor))vc[vfor]++;}
        const myVote=votes[playerId];
        for(const[id,p]of Object.entries(players)){
            const d=document.createElement('div'); d.className='vote-player-item'; if(id===playerId) d.classList.add('you');
            const info=document.createElement('div'); info.className='vote-player-info';
            const name=document.createElement('span'); name.className='vote-player-name'; name.textContent=p.name+(id===playerId?' (You)':''); info.appendChild(name);
            if(myVote===id){const lbl=document.createElement('span');lbl.className='your-vote-label';lbl.textContent='[your vote]';info.appendChild(lbl);}
            d.appendChild(info);
            const cnt=document.createElement('span');cnt.className='vote-count';cnt.textContent=vc[id];d.appendChild(cnt);
            if(id!==playerId){
                const btn=document.createElement('button');btn.className='vote-btn';
                if(myVote===id){btn.classList.add('voted');btn.textContent='VOTED';}else{btn.textContent='VOTE';}
                btn.onclick=()=>castVote(id);d.appendChild(btn);
            }
            c.appendChild(d);
        }
        const votedCnt=Object.values(votes).filter(v=>v!==null).length;
        document.getElementById('voteStatus').textContent=votedCnt+'/'+total+' voted';
        const maj=Math.floor(total/2)+1;
        for(const[id,cnt]of Object.entries(vc)){if(cnt>=maj&&isHost){roomRef.update({status:'results'});break;}}
    }

    async function castVote(tid) { if(!roomRef||!playerId)return; await roomRef.child('gameData/votes/'+playerId).set(tid); }

    function showMultiEndScreen(data) {
        const impId=data.gameData.imposterId;
        const impName=data.players[impId]?.name||'Unknown';
        const word=data.gameData.word;
        const votes=data.gameData.votes||{};
        const vc={}; Object.keys(data.players).forEach(id=>vc[id]=0);
        for(const[vid,vfor]of Object.entries(votes)){if(vfor&&vc.hasOwnProperty(vfor))vc[vfor]++;}
        let maxV=0,mostId=null;
        for(const[id,cnt]of Object.entries(vc)){if(cnt>maxV){maxV=cnt;mostId=id;}}
        const caught=mostId===impId;
        document.getElementById('resultName').textContent=impName;
        document.getElementById('resultWord').textContent='The word was: '+word;
        const rc=document.getElementById('resultCard'),rm=document.getElementById('resultMessage');
        if(caught){rc.className='result-card caught';rm.textContent='IMPOSTER CAUGHT!';}
        else{rc.className='result-card escaped';rm.textContent='IMPOSTER ESCAPED!';}
        const c=document.getElementById('endPlayerList');c.innerHTML='';
        for(const[id,p]of Object.entries(data.players)){
            const d=document.createElement('div');d.className='vote-player-item';
            if(id===impId)d.style.border='2px solid #ff0066';
            const info=document.createElement('div');info.className='vote-player-info';
            const name=document.createElement('span');name.className='vote-player-name';
            name.textContent=p.name+(id===impId?' [IMP]':'');info.appendChild(name);d.appendChild(info);
            const cnt=document.createElement('span');cnt.className='vote-count';cnt.textContent=vc[id]||0;d.appendChild(cnt);
            c.appendChild(d);
        }
        updateEndScreenButtons();
        showScreen('multiEndScreen');
    }

    function updateEndScreenButtons() {
        if(isHost){document.getElementById('newRoundBtn').style.display='block';document.getElementById('backToLobbyBtn').style.display='block';document.getElementById('leaveRoomEndBtn').style.display='none';document.getElementById('endStatus').style.display='none';}
        else{document.getElementById('newRoundBtn').style.display='none';document.getElementById('backToLobbyBtn').style.display='none';document.getElementById('leaveRoomEndBtn').style.display='block';document.getElementById('endStatus').style.display='block';}
    }

    async function newMultiRound() {
        if(!isHost)return;
        const snap=await roomRef.once('value');const data=snap.val();
        const pids=Object.keys(data.players);
        const impIdx=Math.floor(Math.random()*pids.length);
        const impId=pids[impIdx];
        const gw=data.words||multiModeWords;
        const word=getNextMultiWord(gw);
        const roles={},votes={};
        pids.forEach(id=>{roles[id]={isImposter:id===impId,word:id===impId?null:word};votes[id]=null;});
        await roomRef.update({gameData:{roles,word,imposterId:impId,votes},status:'playing'});
    }

    async function backToMultiLobby() { if(!isHost)return; await roomRef.update({gameData:null,status:'lobby'}); }

    function showMultiLobbyFromEnd(data) {
        document.getElementById('displayRoomCode').textContent=roomCode;
        if(isHost){document.getElementById('startGameBtn').style.display='block';document.getElementById('lobbyStatus').style.display='none';}
        else{document.getElementById('startGameBtn').style.display='none';document.getElementById('lobbyStatus').style.display='block';}
        initMultiWordEditor();
        showScreen('multiLobbyScreen');
    }

    async function leaveRoom() {
        if(roomRef&&playerId){
            roomRef.off();
            await roomRef.child('players/'+playerId).remove();
            if(isHost){
                const snap=await roomRef.child('players').once('value');
                const players=snap.val();
                if(players){const nid=Object.keys(players)[0];await roomRef.update({host:nid});await roomRef.child('players/'+nid+'/isHost').set(true);}
                else{await roomRef.remove();}
            }
        }
        playerId=null;roomCode=null;isHost=false;roomRef=null;
        multiModeWords=[...defaultWords];multiWordQueue=[];
        document.getElementById('menuError').textContent='';
        document.getElementById('playerName').value='';
        document.getElementById('joinCode').value='';
        showScreen('impModeScreen');
    }

    // ============================================================
    // BRASKET HANDOM: LOCAL
    // ============================================================
    let brLocalPlayers = 1;
    let brLocalSide = 'left';

    function brSetPlayerCount(n) {
        brLocalPlayers = n;
        document.getElementById('br1PBtn').classList.toggle('selected', n===1);
        document.getElementById('br2PBtn').classList.toggle('selected', n===2);
        // Show side select only for 1P
        document.getElementById('brSideSelect').style.display = n===1 ? 'flex' : 'none';
        document.getElementById('brSideLabel').style.display = n===1 ? 'block' : 'none';
    }

    function brSetSide(s) {
        brLocalSide = s;
        document.getElementById('brLeftBtn').classList.toggle('selected', s==='left');
        document.getElementById('brRightBtn').classList.toggle('selected', s==='right');
    }

    function startBrLocal() {
        document.getElementById('brIframe').src = 'https://2048taylorswift.github.io/basketrandom/';
        showScreen('brLocalGame');
    }

    function exitBrLocal() {
        document.getElementById('brIframe').src = '';
        showScreen('brLocalSetup');
    }

    // ============================================================
    // BRASKET HANDOM: ONLINE (WebRTC + Real Game)
    // ============================================================
    let brOnlineSide = 'left';
    let brOnlinePlayerId = null;
    let brOnlinePlayerName = '';
    let brOnlineRoomCode = null;
    let brOnlineIsHost = false;
    let brOnlineRoomRef = null;
    let brPeerConn = null;
    let brDataChannel = null;
    let brGameIframe = null;

    // =============================================
    // BRASKET HANDOM - WebRTC + Real Game Engine
    // =============================================
    const BR_CDN = 'https://cdn.jsdelivr.net/gh/bubbls/ruffle@1520d90d7b2994737acd8f7a633d018f63c22ca7/';

    function buildGameHTML() {
        const SE = '<' + '/script>';
        return '<!DOCTYPE html><html><head>' +
            '<meta charset="UTF-8">' +
            '<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">' +
            '<base href="' + BR_CDN + '">' +
            '<style>html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000}' +
            'canvas{display:block;width:100%;height:100%;object-fit:contain}</style>' +
            '</head><body>' +
            '<div id="loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-family:sans-serif;text-align:center;">' +
            '<p style="font-size:1.2em;">Loading game...</p></div>' +
            '<script src="box2d.js">' + SE +
            '<script src="main.js">' + SE +
            '<script>' +
            'window.addEventListener("message",function(e){' +
            'if(e.data&&(e.data.type==="keydown"||e.data.type==="keyup")){' +
            'document.dispatchEvent(new KeyboardEvent(e.data.type,{' +
            'key:e.data.key,code:e.data.code,' +
            'keyCode:e.data.keyCode,which:e.data.keyCode,' +
            'bubbles:true,cancelable:true' +
            '}));}});' + SE +
            '</body></html>';
    }

    const RTC_CONFIG = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };

    // Wait for canvas element in iframe
    function waitForCanvas(iframe) {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const check = () => {
                attempts++;
                try {
                    const canvas = iframe.contentDocument.querySelector('canvas');
                    if (canvas) {
                        setTimeout(() => resolve(canvas), 500);
                        return;
                    }
                } catch(e) {}
                if (attempts > 150) { reject(new Error('Timeout waiting for game canvas')); return; }
                setTimeout(check, 200);
            };
            check();
        });
    }



    // Side selection
    function brOnlineSetSide(s) {
        brOnlineSide = s;
        document.getElementById('brOnLeftBtn').classList.toggle('selected', s === 'left');
        document.getElementById('brOnRightBtn').classList.toggle('selected', s === 'right');
    }

    // Create room
    async function brCreateRoom() {
        brOnlinePlayerName = document.getElementById('brPlayerName').value.trim();
        if (!brOnlinePlayerName) { document.getElementById('brMenuError').textContent = 'Enter your name!'; return; }

        brOnlinePlayerId = generatePlayerId();
        brOnlineRoomCode = generateRoomCode();
        brOnlineIsHost = true;

        brOnlineRoomRef = db.ref('brRooms/' + brOnlineRoomCode);
        const snap = await brOnlineRoomRef.once('value');
        if (snap.exists()) { brOnlineRoomCode = generateRoomCode(); brOnlineRoomRef = db.ref('brRooms/' + brOnlineRoomCode); }

        await brOnlineRoomRef.set({
            host: brOnlinePlayerId,
            status: 'lobby',
            players: { [brOnlinePlayerId]: { name: brOnlinePlayerName, side: brOnlineSide } },
            gameState: null,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        brOnlineRoomRef.child('players/' + brOnlinePlayerId).onDisconnect().remove();
        setupBrRoomListeners();

        document.getElementById('brDisplayRoomCode').textContent = brOnlineRoomCode;
        document.getElementById('brStartBtn').style.display = 'block';
        document.getElementById('brLobbyStatus').textContent = 'Waiting for opponent...';

        showScreen('brOnlineLobby');
    }

    // Join room
    async function brJoinRoom() {
        brOnlinePlayerName = document.getElementById('brPlayerName').value.trim();
        const code = document.getElementById('brJoinCode').value.trim().toUpperCase();
        if (!brOnlinePlayerName) { document.getElementById('brMenuError').textContent = 'Enter your name!'; return; }
        if (!code || code.length !== 4) { document.getElementById('brMenuError').textContent = 'Enter a valid 4-letter code!'; return; }

        brOnlineRoomRef = db.ref('brRooms/' + code);
        const snap = await brOnlineRoomRef.once('value');
        if (!snap.exists()) { document.getElementById('brMenuError').textContent = 'Room not found!'; return; }

        const rd = snap.val();
        if (rd.status !== 'lobby') { document.getElementById('brMenuError').textContent = 'Game already started!'; return; }

        const existingPlayers = Object.values(rd.players || {});
        if (existingPlayers.length >= 2) { document.getElementById('brMenuError').textContent = 'Room is full!'; return; }

        // Auto-assign opposite side if same side chosen
        const hostSide = existingPlayers[0]?.side || 'left';
        if (brOnlineSide === hostSide) {
            brOnlineSide = hostSide === 'left' ? 'right' : 'left';
            brOnlineSetSide(brOnlineSide);
        }

        brOnlinePlayerId = generatePlayerId();
        brOnlineRoomCode = code;
        brOnlineIsHost = false;

        await brOnlineRoomRef.child('players/' + brOnlinePlayerId).set({ name: brOnlinePlayerName, side: brOnlineSide });
        brOnlineRoomRef.child('players/' + brOnlinePlayerId).onDisconnect().remove();
        setupBrRoomListeners();

        document.getElementById('brDisplayRoomCode').textContent = brOnlineRoomCode;
        document.getElementById('brStartBtn').style.display = 'none';
        document.getElementById('brLobbyStatus').textContent = 'Waiting for host to start...';

        showScreen('brOnlineLobby');
    }

    function setupBrRoomListeners() {
        brOnlineRoomRef.on('value', (snap) => {
            if (!snap.exists()) {
                brCleanup();
                alert('Room closed!');
                showScreen('brOnlineMenu');
                return;
            }

            const data = snap.val();
            if (data.host === brOnlinePlayerId) brOnlineIsHost = true;

            // Update lobby player list
            const plc = document.getElementById('brPlayerListContainer');
            if (plc && data.players) {
                plc.innerHTML = '';
                for (const [id, p] of Object.entries(data.players)) {
                    const d = document.createElement('div');
                    d.className = 'player-item';
                    if (id === brOnlinePlayerId) d.classList.add('you');
                    d.textContent = p.name + ' (' + p.side.toUpperCase() + ')' + (id === brOnlinePlayerId ? ' - You' : '');
                    plc.appendChild(d);
                }

                const cnt = Object.keys(data.players).length;
                if (brOnlineIsHost) {
                    document.getElementById('brStartBtn').style.display = 'block';
                    document.getElementById('brStartBtn').disabled = cnt < 2;
                    document.getElementById('brStartBtn').textContent = cnt < 2 ? 'NEED 2 PLAYERS' : 'START';
                }
            }

            // Game started
            if (data.status === 'playing' && currentScreen === 'brOnlineLobby') {
                brStartGameplay();
            }

            // Back to lobby
            if (data.status === 'lobby' && currentScreen === 'brOnlineGame') {
                brCleanupWebRTC();
                showScreen('brOnlineLobby');
            }
        });
    }

    // Start online game (host only)
    async function brStartOnlineGame() {
        if (!brOnlineIsHost) return;
        const snap = await brOnlineRoomRef.once('value');
        const data = snap.val();
        if (Object.keys(data.players || {}).length < 2) return;

        // Clear any previous WebRTC signaling data
        await brOnlineRoomRef.child('webrtc').remove();
        await brOnlineRoomRef.update({ status: 'playing' });
    }

    // Both players enter the game screen
    function brStartGameplay() {
        showScreen('brOnlineGame');
        const statusEl = document.getElementById('brOnlineConnStatus');
        statusEl.style.display = 'block';

        if (brOnlineIsHost) {
            // Host: load game in iframe and set up WebRTC
            statusEl.textContent = 'Loading game...';
            document.getElementById('brOnlineIframeWrap').style.display = 'block';
            document.getElementById('brGameVideo').style.display = 'none';
            document.getElementById('brOnlineTip').textContent =
                'You are the host. Select "2 PLAYER" in the game menu. You play ' +
                brOnlineSide.toUpperCase() + ' side (' + (brOnlineSide === 'left' ? 'W key' : 'UP arrow') + ').';

            const iframe = document.getElementById('brGameIframe');
            brGameIframe = iframe;
            iframe.srcdoc = buildGameHTML();

            // Wait for canvas then set up WebRTC
            waitForCanvas(iframe).then(canvas => {
                statusEl.textContent = 'Connecting to opponent...';
                brSetupHostWebRTC(canvas);
            }).catch(err => {
                statusEl.textContent = 'Failed to load game. Try leaving and rejoining.';
                console.error('Canvas wait error:', err);
            });
        } else {
            // Client: show video, set up WebRTC
            statusEl.textContent = 'Waiting for host to load game...';
            document.getElementById('brOnlineIframeWrap').style.display = 'none';
            document.getElementById('brGameVideo').style.display = 'block';
            document.getElementById('brOnlineTip').textContent =
                'You are viewing the host\'s game. You play ' +
                brOnlineSide.toUpperCase() + ' side (' + (brOnlineSide === 'left' ? 'W key' : 'UP arrow') + '). Press your key to play!';

            brSetupClientWebRTC();
        }
    }

    // Host: Set up WebRTC peer connection and stream game canvas
    async function brSetupHostWebRTC(canvas) {
        brPeerConn = new RTCPeerConnection(RTC_CONFIG);

        // Create data channel for receiving client inputs
        brDataChannel = brPeerConn.createDataChannel('inputs');
        brDataChannel.onmessage = (e) => {
            try {
                const msg = JSON.parse(e.data);
                if (brGameIframe && brGameIframe.contentWindow) {
                    brGameIframe.contentWindow.postMessage(msg, '*');
                }
            } catch(err) { console.error('Data channel message error:', err); }
        };

        // Capture game canvas stream and add to peer connection
        const stream = canvas.captureStream(30);
        stream.getTracks().forEach(track => brPeerConn.addTrack(track, stream));

        // ICE connection state monitoring
        brPeerConn.oniceconnectionstatechange = () => {
            if (!brPeerConn) return;
            const state = brPeerConn.iceConnectionState;
            const statusEl = document.getElementById('brOnlineConnStatus');
            if (state === 'connected' || state === 'completed') {
                statusEl.textContent = 'Opponent connected!';
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
            } else if (state === 'failed') {
                statusEl.textContent = 'Connection failed. Try leaving and rejoining.';
                statusEl.style.display = 'block';
            } else if (state === 'disconnected') {
                statusEl.textContent = 'Opponent disconnected...';
                statusEl.style.display = 'block';
            }
        };

        // Send ICE candidates to Firebase
        brPeerConn.onicecandidate = (e) => {
            if (e.candidate && brOnlineRoomRef) {
                brOnlineRoomRef.child('webrtc/hostCandidates').push(e.candidate.toJSON());
            }
        };

        // Create and send offer
        const offer = await brPeerConn.createOffer();
        await brPeerConn.setLocalDescription(offer);
        await brOnlineRoomRef.child('webrtc/offer').set({
            type: offer.type,
            sdp: offer.sdp
        });

        // Listen for client's answer
        brOnlineRoomRef.child('webrtc/answer').on('value', async (snap) => {
            const answer = snap.val();
            if (answer && brPeerConn && brPeerConn.signalingState !== 'stable') {
                try {
                    await brPeerConn.setRemoteDescription(new RTCSessionDescription(answer));
                } catch(e) { console.error('Error setting answer:', e); }
            }
        });

        // Listen for client's ICE candidates
        brOnlineRoomRef.child('webrtc/clientCandidates').on('child_added', async (snap) => {
            const candidate = snap.val();
            if (candidate && brPeerConn) {
                try {
                    await brPeerConn.addIceCandidate(new RTCIceCandidate(candidate));
                } catch(e) { console.error('Error adding client ICE candidate:', e); }
            }
        });
    }

    // Client: Set up WebRTC peer connection to receive game stream
    function brSetupClientWebRTC() {
        brPeerConn = new RTCPeerConnection(RTC_CONFIG);

        // Receive video stream from host
        brPeerConn.ontrack = (e) => {
            const video = document.getElementById('brGameVideo');
            video.srcObject = e.streams[0];
            video.play().catch(() => {});
        };

        // Receive data channel (for future use)
        brPeerConn.ondatachannel = (e) => {
            brDataChannel = e.channel;
        };

        // ICE connection state monitoring
        brPeerConn.oniceconnectionstatechange = () => {
            if (!brPeerConn) return;
            const state = brPeerConn.iceConnectionState;
            const statusEl = document.getElementById('brOnlineConnStatus');
            if (state === 'connected' || state === 'completed') {
                statusEl.textContent = 'Connected!';
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
            } else if (state === 'failed') {
                statusEl.textContent = 'Connection failed. Try leaving and rejoining.';
                statusEl.style.display = 'block';
            } else if (state === 'disconnected') {
                statusEl.textContent = 'Host disconnected...';
                statusEl.style.display = 'block';
            }
        };

        // Send ICE candidates to Firebase
        brPeerConn.onicecandidate = (e) => {
            if (e.candidate && brOnlineRoomRef) {
                brOnlineRoomRef.child('webrtc/clientCandidates').push(e.candidate.toJSON());
            }
        };

        // Listen for host's offer
        brOnlineRoomRef.child('webrtc/offer').on('value', async (snap) => {
            const offer = snap.val();
            if (offer && brPeerConn && brPeerConn.signalingState === 'stable') {
                try {
                    await brPeerConn.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await brPeerConn.createAnswer();
                    await brPeerConn.setLocalDescription(answer);
                    await brOnlineRoomRef.child('webrtc/answer').set({
                        type: answer.type,
                        sdp: answer.sdp
                    });
                } catch(e) { console.error('Error handling offer:', e); }
            }
        });

        // Listen for host's ICE candidates
        brOnlineRoomRef.child('webrtc/hostCandidates').on('child_added', async (snap) => {
            const candidate = snap.val();
            if (candidate && brPeerConn) {
                try {
                    await brPeerConn.addIceCandidate(new RTCIceCandidate(candidate));
                } catch(e) { console.error('Error adding host ICE candidate:', e); }
            }
        });
    }

    // Clean up WebRTC connection
    function brCleanupWebRTC() {
        if (brDataChannel) { brDataChannel.close(); brDataChannel = null; }
        if (brPeerConn) { brPeerConn.close(); brPeerConn = null; }
        brGameIframe = null;
        const iframe = document.getElementById('brGameIframe');
        if (iframe) iframe.srcdoc = '';
        const video = document.getElementById('brGameVideo');
        if (video) { video.srcObject = null; video.style.display = 'none'; }
    }

    function brCleanup() {
        brCleanupWebRTC();
        if (brOnlineRoomRef) brOnlineRoomRef.off();
        brOnlineRoomRef = null;
        brOnlinePlayerId = null;
        brOnlineRoomCode = null;
        brOnlineIsHost = false;
    }

    async function brLeaveRoom() {
        if (brOnlineRoomRef && brOnlinePlayerId) {
            brOnlineRoomRef.off();
            await brOnlineRoomRef.child('players/' + brOnlinePlayerId).remove();
            if (brOnlineIsHost) {
                const snap = await brOnlineRoomRef.child('players').once('value');
                const players = snap.val();
                if (players) {
                    const nid = Object.keys(players)[0];
                    await brOnlineRoomRef.update({ host: nid });
                } else {
                    await brOnlineRoomRef.remove();
                }
            }
        }
        brCleanup();
        document.getElementById('brMenuError').textContent = '';
        document.getElementById('brPlayerName').value = '';
        document.getElementById('brJoinCode').value = '';
        showScreen('brModeScreen');
    }

    function brLeaveOnlineGame() {
        brLeaveRoom();
    }

    // ============================================================
    // INPUT HANDLING (Client sends keys via WebRTC data channel)
    // ============================================================
    document.addEventListener('keydown', (e) => {
        if (currentScreen !== 'brOnlineGame') return;

        // Client: send key presses to host via data channel
        if (!brOnlineIsHost && brDataChannel && brDataChannel.readyState === 'open') {
            const key = e.key;
            if (key === 'w' || key === 'W' || key === 'ArrowUp' || key === ' ') {
                e.preventDefault();
                brDataChannel.send(JSON.stringify({
                    type: 'keydown',
                    key: e.key,
                    code: e.code,
                    keyCode: e.keyCode
                }));
            }
        }
    });

    document.addEventListener('keyup', (e) => {
        if (currentScreen !== 'brOnlineGame') return;

        // Client: send key releases to host via data channel
        if (!brOnlineIsHost && brDataChannel && brDataChannel.readyState === 'open') {
            const key = e.key;
            if (key === 'w' || key === 'W' || key === 'ArrowUp' || key === ' ') {
                e.preventDefault();
                brDataChannel.send(JSON.stringify({
                    type: 'keyup',
                    key: e.key,
                    code: e.code,
                    keyCode: e.keyCode
                }));
            }
        }
    });

    // ============================================================
    // INIT
    // ============================================================
    document.getElementById('joinCode').addEventListener('input', function() { this.value = this.value.toUpperCase(); });
    document.getElementById('brJoinCode').addEventListener('input', function() { this.value = this.value.toUpperCase(); });

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('singleWordTextarea').addEventListener('input', updateSingleWordCount);
        document.getElementById('multiWordTextarea').addEventListener('input', updateMultiWordCount);
    });
    </script>
</body>
</html>
