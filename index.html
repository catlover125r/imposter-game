<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; color: white; }
        .container { text-align: center; padding: 20px; width: 100%; max-width: 600px; }
        h1 { font-size: 2.5rem; margin-bottom: 30px; text-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
        .screen { display: none; flex-direction: column; align-items: center; gap: 20px; }
        .screen.active { display: flex; }
        input[type="text"], input[type="number"] { width: 100%; max-width: 300px; padding: 15px; font-size: 1.2rem; border: none; border-radius: 10px; background: #0f3460; color: white; text-align: center; }
        input[type="text"]::placeholder { color: #888; }
        .btn { padding: 15px 40px; font-size: 1.2rem; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s; min-width: 200px; }
        .btn:hover { transform: scale(1.05); }
        .btn-primary { background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%); color: white; }
        .btn-primary:hover { box-shadow: 0 0 30px rgba(233, 69, 96, 0.6); }
        .btn-secondary { background: linear-gradient(135deg, #4ecca3 0%, #45b7aa 100%); color: #1a1a2e; }
        .btn-secondary:hover { box-shadow: 0 0 30px rgba(78, 204, 163, 0.6); }
        .btn-small { padding: 10px 20px; font-size: 1rem; min-width: auto; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .mode-buttons { display: flex; flex-direction: column; gap: 20px; margin: 20px 0; }
        .mode-btn { padding: 30px 40px; font-size: 1.3rem; border-radius: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .mode-btn .icon { font-size: 3rem; }
        .mode-btn .subtitle { font-size: 0.9rem; opacity: 0.8; }
        .word-editor-section { width: 100%; max-width: 400px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .word-list-editor { width: 100%; background: #0f3460; border-radius: 15px; padding: 15px; }
        .word-textarea { width: 100%; height: 150px; background: #1a1a2e; border: 2px solid #4ecca3; border-radius: 10px; color: white; font-size: 1rem; padding: 15px; resize: vertical; font-family: inherit; }
        .word-textarea::placeholder { color: #666; }
        .word-count { margin-top: 10px; color: #888; font-size: 0.9rem; }
        .room-code { background: #0f3460; padding: 20px 40px; border-radius: 15px; font-size: 2.5rem; letter-spacing: 10px; font-weight: bold; color: #4ecca3; border: 2px solid #4ecca3; }
        .player-list { width: 100%; max-width: 350px; background: #0f3460; border-radius: 15px; padding: 20px; margin: 10px 0; }
        .player-list h3 { margin-bottom: 15px; color: #4ecca3; }
        .player-item { padding: 10px; margin: 5px 0; background: #1a1a2e; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .player-item.host::before { content: 'üëë'; }
        .player-item.you { border: 2px solid #4ecca3; }
        .vote-player-item { padding: 12px 15px; margin: 8px 0; background: #1a1a2e; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .vote-player-item.you { border: 2px solid #4ecca3; }
        .vote-player-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .vote-player-name { font-weight: bold; }
        .vote-count { background: #e94560; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.9rem; min-width: 30px; text-align: center; }
        .vote-btn { padding: 8px 20px; font-size: 0.9rem; background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: bold; transition: transform 0.2s; }
        .vote-btn:hover:not(:disabled) { transform: scale(1.05); }
        .vote-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .vote-btn.voted { background: linear-gradient(135deg, #4ecca3 0%, #45b7aa 100%); }
        .your-vote-label { color: #4ecca3; font-size: 0.8rem; margin-left: 5px; }
        .role-card { background: linear-gradient(135deg, #0f3460 0%, #1a1a5e 100%); border-radius: 20px; padding: 40px; margin: 20px 0; border: 3px solid #e94560; min-width: 280px; }
        .role-card.imposter { border-color: #e94560; box-shadow: 0 0 30px rgba(233, 69, 96, 0.5); }
        .role-card.crewmate { border-color: #4ecca3; box-shadow: 0 0 30px rgba(78, 204, 163, 0.5); }
        .role-label { font-size: 1rem; color: #888; margin-bottom: 10px; }
        .role-text { font-size: 2rem; font-weight: bold; }
        .role-card.imposter .role-text { color: #e94560; }
        .role-card.crewmate .role-text { color: #4ecca3; }
        .result-card { background: linear-gradient(135deg, #0f3460 0%, #1a1a5e 100%); border-radius: 20px; padding: 30px; margin: 20px 0; border: 3px solid #4ecca3; min-width: 280px; }
        .result-card.caught { border-color: #4ecca3; box-shadow: 0 0 30px rgba(78, 204, 163, 0.5); }
        .result-card.escaped { border-color: #e94560; box-shadow: 0 0 30px rgba(233, 69, 96, 0.5); }
        .result-label { font-size: 1rem; color: #888; margin-bottom: 10px; }
        .result-name { font-size: 2rem; font-weight: bold; color: #e94560; margin-bottom: 10px; }
        .result-word { font-size: 1.2rem; color: #4ecca3; margin-bottom: 15px; }
        .result-message { font-size: 1.2rem; font-weight: bold; }
        .result-card.caught .result-message { color: #4ecca3; }
        .result-card.escaped .result-message { color: #e94560; }
        .status { color: #888; font-size: 1rem; margin: 10px 0; }
        .status.waiting { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .error { color: #e94560; font-size: 1rem; margin: 10px 0; }
        .or-text { color: #666; margin: 10px 0; }
        .back-btn { position: fixed; top: 20px; left: 20px; background: #0f3460; border: 2px solid #e94560; color: #e94560; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; z-index: 100; }
        .back-btn:hover { background: #e94560; color: white; }
        .player-boxes { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 30px; }
        .player-box { width: 100px; height: 100px; background: linear-gradient(135deg, #0f3460 0%, #1a1a5e 100%); border: 3px solid #e94560; border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 1.3rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .player-box:hover:not(.revealed) { transform: scale(1.1); box-shadow: 0 0 20px rgba(233, 69, 96, 0.6); }
        .player-box.revealed { background: #333; border-color: #555; cursor: not-allowed; opacity: 0.5; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 50px; border-radius: 20px; text-align: center; border: 3px solid #e94560; max-width: 90%; }
        .modal .role-text { font-size: 2.5rem; margin-bottom: 30px; font-weight: bold; }
        .modal .role-text.imposter { color: #e94560; text-shadow: 0 0 20px rgba(233, 69, 96, 0.8); }
        .modal .role-text.crewmate { color: #4ecca3; text-shadow: 0 0 20px rgba(78, 204, 163, 0.8); }
        .end-buttons { display: none; margin-top: 30px; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .button-row { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .instructions { color: #888; font-size: 0.9rem; margin-top: 10px; }
        .vote-instruction { color: #888; font-size: 0.9rem; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="screen active" id="modeScreen">
            <h1>üé≠ IMPOSTER</h1>
            <p style="color: #888; margin-bottom: 20px;">Choose your game mode</p>
            <div class="mode-buttons">
                <button class="btn btn-primary mode-btn" onclick="selectMode('single')">
                    <span class="icon">üì±</span><span>One Device</span><span class="subtitle">Pass the phone around</span>
                </button>
                <button class="btn btn-secondary mode-btn" onclick="selectMode('multi')">
                    <span class="icon">üì±üì±üì±</span><span>Multiple Devices</span><span class="subtitle">Everyone uses their own phone</span>
                </button>
            </div>
        </div>
        <div class="screen" id="singleLobbyScreen">
            <button class="back-btn" onclick="backToModeSelect()">‚Üê</button>
            <h1>üé≠ ONE DEVICE</h1>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                <label for="singlePlayerCount" style="font-size: 1.2rem;">Number of Players:</label>
                <input type="number" id="singlePlayerCount" min="3" max="20" value="4" style="width: 100px; height: 60px; font-size: 2rem;">
            </div>
            <button class="btn btn-primary" onclick="startSingleGame()">PLAY</button>
            <div class="word-editor-section">
                <h3 style="color: #4ecca3; margin-bottom: 10px;">üìù Word List (this game only)</h3>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">One word per line, or separate with commas</p>
                <div class="word-list-editor">
                    <textarea class="word-textarea" id="singleWordTextarea" placeholder="Enter words here..."></textarea>
                    <div class="word-count" id="singleWordCount">0 words</div>
                </div>
                <div class="button-row" style="margin-top: 10px;">
                    <button class="btn btn-secondary btn-small" onclick="resetWordsSingle()">Reset to Default</button>
                </div>
            </div>
            <p class="instructions">Each player taps a box to see their role.<br>One person is the IMPOSTER!</p>
        </div>
        <div class="screen" id="singleGameScreen">
            <h1>üé≠ Tap Your Box!</h1>
            <div class="player-boxes" id="singlePlayerBoxes"></div>
            <div class="end-buttons" id="singleEndButtons">
                <button class="btn btn-secondary" onclick="newSingleRound()">New Round</button>
                <button class="btn btn-primary" onclick="backToSingleLobby()">Back to Lobby</button>
            </div>
        </div>
        <div class="modal" id="singleModal">
            <div class="modal-content">
                <div class="role-text" id="singleRoleText"></div>
                <button class="btn btn-secondary" onclick="closeSingleModal()">OK</button>
            </div>
        </div>
        <div class="screen" id="multiMenuScreen">
            <button class="back-btn" onclick="backToModeSelect()">‚Üê</button>
            <h1>üé≠ MULTIPLAYER</h1>
            <input type="text" id="playerName" placeholder="Enter your name" maxlength="15">
            <button class="btn btn-primary" onclick="createRoom()">Create Room</button>
            <div class="or-text">‚Äî or ‚Äî</div>
            <input type="text" id="joinCode" placeholder="Enter room code" maxlength="6" style="text-transform: uppercase;">
            <button class="btn btn-secondary" onclick="joinRoom()">Join Room</button>
            <p class="error" id="menuError"></p>
        </div>
        <div class="screen" id="multiLobbyScreen">
            <h1>üé≠ LOBBY</h1>
            <p>Room Code:</p>
            <div class="room-code" id="displayRoomCode">----</div>
            <div class="player-list"><h3>Players</h3><div id="playerListContainer"></div></div>
            <button class="btn btn-primary" id="startGameBtn" onclick="startMultiGame()" style="display: none;">Start Game</button>
            <p class="status waiting" id="lobbyStatus">Waiting for host to start...</p>
            <div class="word-editor-section">
                <h3 style="color: #4ecca3; margin-bottom: 10px;">üìù Word List (this room only)</h3>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">One word per line, or separate with commas</p>
                <div class="word-list-editor">
                    <textarea class="word-textarea" id="multiWordTextarea" placeholder="Enter words here..."></textarea>
                    <div class="word-count" id="multiWordCount">0 words</div>
                </div>
                <div class="button-row" style="margin-top: 10px;">
                    <button class="btn btn-secondary btn-small" onclick="resetWordsMulti()">Reset to Default</button>
                    <button class="btn btn-primary btn-small" onclick="saveWordsMulti()">Save for Room</button>
                </div>
            </div>
            <button class="btn btn-secondary btn-small" onclick="leaveRoom()" style="margin-top: 20px;">Leave Room</button>
        </div>
        <div class="screen" id="multiGameScreen">
            <h1 id="roleTitle">üé≠ YOUR ROLE</h1>
            <div class="role-card" id="roleCard">
                <div class="role-label" id="roleLabel">You are:</div>
                <div class="role-text" id="multiRoleText">Loading...</div>
            </div>
            <p class="vote-instruction">Vote for who you think is the imposter!</p>
            <div class="player-list"><h3>üó≥Ô∏è Vote</h3><div id="votePlayerList"></div></div>
            <p class="status" id="voteStatus">Waiting for votes...</p>
        </div>
        <div class="screen" id="multiEndScreen">
            <h1>üé≠ RESULTS</h1>
            <div class="result-card" id="resultCard">
                <div class="result-label">The imposter was:</div>
                <div class="result-name" id="resultName">???</div>
                <div class="result-word" id="resultWord"></div>
                <div class="result-message" id="resultMessage">???</div>
            </div>
            <div class="player-list"><h3>Final Votes</h3><div id="endPlayerList"></div></div>
            <button class="btn btn-secondary" id="newRoundBtn" onclick="newMultiRound()" style="display: none;">New Round</button>
            <button class="btn btn-primary" id="backToLobbyBtn" onclick="backToMultiLobby()" style="display: none;">Back to Lobby</button>
            <p class="status waiting" id="endStatus">Waiting for host...</p>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAOsYfd3vBVUzHqysG_oXPKi7yXrI-hVrE",
            authDomain: "imposter-game-777f3.firebaseapp.com",
            databaseURL: "https://imposter-game-777f3-default-rtdb.firebaseio.com",
            projectId: "imposter-game-777f3",
            storageBucket: "imposter-game-777f3.firebasestorage.app",
            messagingSenderId: "791197389028",
            appId: "1:791197389028:web:72282811d5e08040a7dcf1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Default words - always start fresh with these
        const defaultWords = ["Pizza", "Coffee", "Sushi", "Hamburger", "Ice cream", "Chocolate", "Sandwich", "Pasta", "Cookies", "Bacon", "Elephant", "Dolphin", "Penguin", "Giraffe", "Octopus", "Butterfly", "Tiger", "Kangaroo", "Shark", "Eagle", "Umbrella", "Backpack", "Sunglasses", "Headphones", "Flashlight", "Wallet", "Pillow", "Camera", "Skateboard", "Guitar", "Aces", "Beach", "Library", "Restaurant", "Airport", "Stadium", "Hospital", "Museum", "Gym", "Theater", "Park", "Swimming", "Dancing", "Cooking", "Reading", "Painting", "Camping", "Shopping", "Singing", "Jogging", "Gaming", "Teacher", "Doctor", "Chef", "Firefighter", "Pilot", "Artist", "Scientist", "Musician", "Athlete", "Photographer"];
        
        // Session-only words (not saved to localStorage)
        let singleModeWords = [...defaultWords];
        let multiModeWords = [...defaultWords];

        function parseWordsFromText(text) { return text.split(/[,\n]+/).map(w => w.trim()).filter(w => w.length > 0); }
        function wordsToText(arr) { return arr.join('\n'); }
        
        function updateSingleWordCount() { 
            const t = document.getElementById('singleWordTextarea'); 
            if(t) document.getElementById('singleWordCount').textContent = parseWordsFromText(t.value).length + ' words'; 
        }
        function updateMultiWordCount() { 
            const t = document.getElementById('multiWordTextarea'); 
            if(t) document.getElementById('multiWordCount').textContent = parseWordsFromText(t.value).length + ' words'; 
        }
        
        // Single mode: just update the local session variable
        function updateSingleWords() {
            const t = document.getElementById('singleWordTextarea');
            singleModeWords = parseWordsFromText(t.value);
            if(singleModeWords.length === 0) {
                singleModeWords = [...defaultWords];
                t.value = wordsToText(singleModeWords);
            }
            updateSingleWordCount();
        }
        
        function resetWordsSingle() { 
            singleModeWords = [...defaultWords]; 
            document.getElementById('singleWordTextarea').value = wordsToText(singleModeWords); 
            updateSingleWordCount(); 
        }
        
        // Multi mode: save to Firebase room only
        async function saveWordsMulti() { 
            const t = document.getElementById('multiWordTextarea'); 
            multiModeWords = parseWordsFromText(t.value); 
            if(multiModeWords.length === 0) { 
                multiModeWords = [...defaultWords]; 
                t.value = wordsToText(multiModeWords); 
            } 
            updateMultiWordCount(); 
            if(roomRef) await roomRef.child('words').set(multiModeWords); 
            alert('Words saved for this room!'); 
        }
        
        async function resetWordsMulti() { 
            multiModeWords = [...defaultWords]; 
            document.getElementById('multiWordTextarea').value = wordsToText(multiModeWords); 
            updateMultiWordCount(); 
            if(roomRef) await roomRef.child('words').set(multiModeWords); 
        }
        
        function initSingleWordEditor() { 
            // Always start with default words
            singleModeWords = [...defaultWords];
            const t = document.getElementById('singleWordTextarea'); 
            if(t) { t.value = wordsToText(singleModeWords); updateSingleWordCount(); } 
        }
        
        function initMultiWordEditor() { 
            const t = document.getElementById('multiWordTextarea'); 
            if(t) { t.value = wordsToText(multiModeWords); updateMultiWordCount(); } 
        }

        function selectMode(mode) { 
            if(mode === 'single') { 
                showScreen('singleLobbyScreen'); 
                initSingleWordEditor(); 
            } else { 
                showScreen('multiMenuScreen'); 
            } 
        }
        function backToModeSelect() { 
            if(roomRef && playerId) { leaveRoom(); return; } 
            showScreen('modeScreen'); 
        }
        function showScreen(id) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.back-btn').forEach(b => b.style.display = 'none'); 
            const bb = document.getElementById(id).querySelector('.back-btn'); 
            if(bb) bb.style.display = 'block'; 
        }

        let singlePlayerCount = 4, singleImposterIndex = 0, singleCurrentWord = "", singleRevealedCount = 0, singleCurrentBoxIndex = -1;
        
        function startSingleGame() { 
            // Update words from textarea before starting
            updateSingleWords();
            singlePlayerCount = Math.min(20, Math.max(3, parseInt(document.getElementById('singlePlayerCount').value))); 
            setupSingleRound(); 
            showScreen('singleGameScreen'); 
        }
        function setupSingleRound() { 
            singleImposterIndex = Math.floor(Math.random() * singlePlayerCount); 
            singleCurrentWord = singleModeWords[Math.floor(Math.random() * singleModeWords.length)]; 
            singleRevealedCount = 0; 
            const c = document.getElementById('singlePlayerBoxes'); 
            c.innerHTML = ''; 
            for(let i = 0; i < singlePlayerCount; i++) { 
                const b = document.createElement('div'); 
                b.className = 'player-box'; 
                b.textContent = 'P' + (i+1); 
                b.onclick = () => revealSingleRole(i); 
                c.appendChild(b); 
            } 
            document.getElementById('singleEndButtons').style.display = 'none'; 
        }
        function revealSingleRole(i) { 
            const boxes = document.querySelectorAll('#singlePlayerBoxes .player-box'); 
            if(boxes[i].classList.contains('revealed')) return; 
            singleCurrentBoxIndex = i; 
            const rt = document.getElementById('singleRoleText'); 
            if(i === singleImposterIndex) { rt.textContent = 'IMPOSTER'; rt.className = 'role-text imposter'; } 
            else { rt.textContent = singleCurrentWord; rt.className = 'role-text crewmate'; } 
            document.getElementById('singleModal').style.display = 'flex'; 
        }
        function closeSingleModal() { 
            document.getElementById('singleModal').style.display = 'none'; 
            const boxes = document.querySelectorAll('#singlePlayerBoxes .player-box'); 
            boxes[singleCurrentBoxIndex].classList.add('revealed'); 
            boxes[singleCurrentBoxIndex].textContent = '‚úì'; 
            singleRevealedCount++; 
            if(singleRevealedCount === singlePlayerCount) document.getElementById('singleEndButtons').style.display = 'flex'; 
        }
        function newSingleRound() { setupSingleRound(); }
        function backToSingleLobby() { showScreen('singleLobbyScreen'); }

        let playerId = null, playerName = '', roomCode = null, isHost = false, roomRef = null, currentScreen = 'multiMenuScreen';
        function generatePlayerId() { return 'player_' + Math.random().toString(36).substr(2, 9); }
        function generateRoomCode() { const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let c = ''; for(let i = 0; i < 4; i++) c += chars.charAt(Math.floor(Math.random() * chars.length)); return c; }

        async function createRoom() {
            playerName = document.getElementById('playerName').value.trim();
            if(!playerName) { document.getElementById('menuError').textContent = 'Please enter your name!'; return; }
            playerId = generatePlayerId(); roomCode = generateRoomCode(); isHost = true;
            roomRef = db.ref('rooms/' + roomCode);
            const snap = await roomRef.once('value');
            if(snap.exists()) { roomCode = generateRoomCode(); roomRef = db.ref('rooms/' + roomCode); }
            
            // Always start room with default words
            multiModeWords = [...defaultWords];
            
            await roomRef.set({ 
                host: playerId, 
                status: 'lobby', 
                players: { [playerId]: { name: playerName, isHost: true } }, 
                gameData: null, 
                words: multiModeWords, 
                createdAt: firebase.database.ServerValue.TIMESTAMP 
            });
            roomRef.child('players/' + playerId).onDisconnect().remove();
            setupRoomListeners();
            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('startGameBtn').style.display = 'block';
            document.getElementById('lobbyStatus').style.display = 'none';
            initMultiWordEditor();
            showScreen('multiLobbyScreen'); currentScreen = 'multiLobbyScreen';
        }

        async function joinRoom() {
            playerName = document.getElementById('playerName').value.trim();
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if(!playerName) { document.getElementById('menuError').textContent = 'Please enter your name!'; return; }
            if(!code || code.length !== 4) { document.getElementById('menuError').textContent = 'Please enter a valid 4-letter room code!'; return; }
            roomCode = code; roomRef = db.ref('rooms/' + roomCode);
            const snap = await roomRef.once('value');
            if(!snap.exists()) { document.getElementById('menuError').textContent = 'Room not found!'; return; }
            const rd = snap.val();
            if(rd.status !== 'lobby') { document.getElementById('menuError').textContent = 'Game already in progress!'; return; }
            playerId = generatePlayerId(); isHost = false;
            
            // Load room's words
            multiModeWords = rd.words || [...defaultWords];
            
            await roomRef.child('players/' + playerId).set({ name: playerName, isHost: false });
            roomRef.child('players/' + playerId).onDisconnect().remove();
            setupRoomListeners();
            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('startGameBtn').style.display = 'none';
            document.getElementById('lobbyStatus').style.display = 'block';
            initMultiWordEditor();
            showScreen('multiLobbyScreen'); currentScreen = 'multiLobbyScreen';
        }

        function setupRoomListeners() {
            roomRef.on('value', (snap) => {
                if(!snap.exists()) { alert('Room was closed!'); showScreen('multiMenuScreen'); currentScreen = 'multiMenuScreen'; roomRef = null; return; }
                const data = snap.val();
                
                // Sync words from Firebase for this room
                if(data.words && Array.isArray(data.words)) { 
                    multiModeWords = data.words; 
                    const t = document.getElementById('multiWordTextarea'); 
                    if(t && currentScreen === 'multiLobbyScreen') { 
                        t.value = wordsToText(multiModeWords); 
                        updateMultiWordCount(); 
                    } 
                }
                
                if(data.host === playerId) isHost = true;
                updateLobbyPlayerList(data.players);
                if(data.status === 'playing' && currentScreen === 'multiLobbyScreen') { showMultiGameScreen(data); }
                else if(data.status === 'playing' && currentScreen === 'multiGameScreen') { updateVotingUI(data); }
                else if(data.status === 'results' && currentScreen === 'multiGameScreen') { showMultiEndScreen(data); }
                else if(data.status === 'lobby' && (currentScreen === 'multiEndScreen' || currentScreen === 'multiGameScreen')) { showMultiLobbyFromEnd(data); }
                if(currentScreen === 'multiEndScreen') updateEndScreenButtons();
            });
        }

        function updateLobbyPlayerList(players) {
            const c = document.getElementById('playerListContainer'); if(!c) return; c.innerHTML = '';
            for(const [id, p] of Object.entries(players || {})) {
                const d = document.createElement('div'); d.className = 'player-item';
                if(p.isHost) d.classList.add('host'); if(id === playerId) d.classList.add('you');
                d.textContent = p.name + (id === playerId ? ' (You)' : ''); c.appendChild(d);
            }
            const cnt = Object.keys(players || {}).length;
            const btn = document.getElementById('startGameBtn');
            if(btn && isHost) { btn.disabled = cnt < 3; btn.textContent = cnt < 3 ? 'Need 3+ Players' : 'Start Game'; }
        }

        async function startMultiGame() {
            if(!isHost) return;
            const snap = await roomRef.once('value'); const data = snap.val();
            const playerIds = Object.keys(data.players);
            if(playerIds.length < 3) { alert('Need at least 3 players!'); return; }
            const impIdx = Math.floor(Math.random() * playerIds.length);
            const imposterId = playerIds[impIdx];
            const gameWords = data.words || multiModeWords;
            const word = gameWords[Math.floor(Math.random() * gameWords.length)];
            const roles = {}, votes = {};
            playerIds.forEach(id => { roles[id] = { isImposter: id === imposterId, word: id === imposterId ? null : word }; votes[id] = null; });
            await roomRef.update({ gameData: { roles, word, imposterId, votes }, status: 'playing' });
        }

        function showMultiGameScreen(data) {
            const myRole = data.gameData.roles[playerId];
            const rc = document.getElementById('roleCard'), rt = document.getElementById('multiRoleText');
            const title = document.getElementById('roleTitle'), label = document.getElementById('roleLabel');
            if(myRole.isImposter) { 
                rc.className = 'role-card imposter'; 
                rt.textContent = 'IMPOSTER'; 
                title.textContent = 'üé≠ YOUR ROLE';
                label.style.display = 'block';
                label.textContent = 'You are:';
            }
            else { 
                rc.className = 'role-card crewmate'; 
                rt.textContent = myRole.word; 
                title.textContent = 'üé≠ YOUR WORD';
                label.style.display = 'none';
            }
            updateVotingUI(data);
            showScreen('multiGameScreen'); currentScreen = 'multiGameScreen';
        }

        function updateVotingUI(data) {
            const c = document.getElementById('votePlayerList'); if(!c) return; c.innerHTML = '';
            const players = data.players, votes = data.gameData.votes || {};
            const playerIds = Object.keys(players), total = playerIds.length;
            const voteCounts = {}; playerIds.forEach(id => voteCounts[id] = 0);
            for(const [vid, vfor] of Object.entries(votes)) { if(vfor && voteCounts.hasOwnProperty(vfor)) voteCounts[vfor]++; }
            const myVote = votes[playerId];
            for(const [id, p] of Object.entries(players)) {
                const d = document.createElement('div'); d.className = 'vote-player-item'; if(id === playerId) d.classList.add('you');
                const info = document.createElement('div'); info.className = 'vote-player-info';
                const name = document.createElement('span'); name.className = 'vote-player-name'; name.textContent = p.name + (id === playerId ? ' (You)' : ''); info.appendChild(name);
                if(myVote === id) { const lbl = document.createElement('span'); lbl.className = 'your-vote-label'; lbl.textContent = '‚úì Your vote'; info.appendChild(lbl); }
                d.appendChild(info);
                const cnt = document.createElement('span'); cnt.className = 'vote-count'; cnt.textContent = voteCounts[id]; d.appendChild(cnt);
                if(id !== playerId) {
                    const btn = document.createElement('button'); btn.className = 'vote-btn';
                    if(myVote === id) { btn.classList.add('voted'); btn.textContent = 'Voted'; }
                    else if(myVote) { btn.textContent = 'Vote'; btn.disabled = true; }
                    else { btn.textContent = 'Vote'; }
                    btn.onclick = () => castVote(id); d.appendChild(btn);
                }
                c.appendChild(d);
            }
            const votedCnt = Object.values(votes).filter(v => v !== null).length;
            document.getElementById('voteStatus').textContent = votedCnt + '/' + total + ' players voted';
            const majority = Math.floor(total / 2) + 1;
            for(const [id, cnt] of Object.entries(voteCounts)) {
                if(cnt >= majority && isHost) { roomRef.update({ status: 'results' }); break; }
            }
        }

        async function castVote(targetId) { if(!roomRef || !playerId) return; await roomRef.child('gameData/votes/' + playerId).set(targetId); }

        function showMultiEndScreen(data) {
            const imposterId = data.gameData.imposterId;
            const imposterName = data.players[imposterId]?.name || 'Unknown';
            const word = data.gameData.word;
            const votes = data.gameData.votes || {};
            const voteCounts = {}; Object.keys(data.players).forEach(id => voteCounts[id] = 0);
            for(const [vid, vfor] of Object.entries(votes)) { if(vfor && voteCounts.hasOwnProperty(vfor)) voteCounts[vfor]++; }
            let maxVotes = 0, mostVotedId = null;
            for(const [id, cnt] of Object.entries(voteCounts)) { if(cnt > maxVotes) { maxVotes = cnt; mostVotedId = id; } }
            const caught = mostVotedId === imposterId;
            document.getElementById('resultName').textContent = imposterName;
            document.getElementById('resultWord').textContent = 'The word was: ' + word;
            const rc = document.getElementById('resultCard'), rm = document.getElementById('resultMessage');
            if(caught) { rc.className = 'result-card caught'; rm.textContent = 'üéâ Imposter was caught!'; }
            else { rc.className = 'result-card escaped'; rm.textContent = 'üòà Imposter escaped!'; }
            const c = document.getElementById('endPlayerList'); c.innerHTML = '';
            for(const [id, p] of Object.entries(data.players)) {
                const d = document.createElement('div'); d.className = 'vote-player-item';
                if(id === imposterId) d.style.border = '2px solid #e94560';
                const info = document.createElement('div'); info.className = 'vote-player-info';
                const name = document.createElement('span'); name.className = 'vote-player-name';
                name.textContent = p.name + (id === imposterId ? ' üé≠' : ''); info.appendChild(name); d.appendChild(info);
                const cnt = document.createElement('span'); cnt.className = 'vote-count'; cnt.textContent = voteCounts[id] || 0; d.appendChild(cnt);
                c.appendChild(d);
            }
            updateEndScreenButtons();
            showScreen('multiEndScreen'); currentScreen = 'multiEndScreen';
        }

        function updateEndScreenButtons() {
            if(isHost) { document.getElementById('newRoundBtn').style.display = 'block'; document.getElementById('backToLobbyBtn').style.display = 'block'; document.getElementById('endStatus').style.display = 'none'; }
            else { document.getElementById('newRoundBtn').style.display = 'none'; document.getElementById('backToLobbyBtn').style.display = 'none'; document.getElementById('endStatus').style.display = 'block'; }
        }

        async function newMultiRound() {
            if(!isHost) return;
            const snap = await roomRef.once('value'); const data = snap.val();
            const playerIds = Object.keys(data.players);
            const impIdx = Math.floor(Math.random() * playerIds.length);
            const imposterId = playerIds[impIdx];
            const gameWords = data.words || multiModeWords;
            const word = gameWords[Math.floor(Math.random() * gameWords.length)];
            const roles = {}, votes = {};
            playerIds.forEach(id => { roles[id] = { isImposter: id === imposterId, word: id === imposterId ? null : word }; votes[id] = null; });
            await roomRef.update({ gameData: { roles, word, imposterId, votes }, status: 'playing' });
        }

        async function backToMultiLobby() { if(!isHost) return; await roomRef.update({ gameData: null, status: 'lobby' }); }

        function showMultiLobbyFromEnd(data) {
            document.getElementById('displayRoomCode').textContent = roomCode;
            if(isHost) { document.getElementById('startGameBtn').style.display = 'block'; document.getElementById('lobbyStatus').style.display = 'none'; }
            else { document.getElementById('startGameBtn').style.display = 'none'; document.getElementById('lobbyStatus').style.display = 'block'; }
            initMultiWordEditor();
            showScreen('multiLobbyScreen'); currentScreen = 'multiLobbyScreen';
        }

        async function leaveRoom() {
            if(roomRef && playerId) {
                roomRef.off();
                await roomRef.child('players/' + playerId).remove();
                if(isHost) {
                    const snap = await roomRef.child('players').once('value');
                    const players = snap.val();
                    if(players) { const newHostId = Object.keys(players)[0]; await roomRef.update({ host: newHostId }); await roomRef.child('players/' + newHostId + '/isHost').set(true); }
                    else { await roomRef.remove(); }
                }
            }
            playerId = null; roomCode = null; isHost = false; roomRef = null;
            // Reset to default words when leaving
            multiModeWords = [...defaultWords];
            document.getElementById('menuError').textContent = '';
            document.getElementById('playerName').value = '';
            document.getElementById('joinCode').value = '';
            showScreen('modeScreen'); currentScreen = 'multiMenuScreen';
        }

        document.getElementById('joinCode').addEventListener('input', function() { this.value = this.value.toUpperCase(); });
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('singleWordTextarea').addEventListener('input', updateSingleWordCount);
            document.getElementById('multiWordTextarea').addEventListener('input', updateMultiWordCount);
        });
    </script>
</body>
</html>
