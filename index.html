<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .container {
            text-align: center;
            padding: 20px;
            width: 100%;
            max-width: 600px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4ecca3;
        }

        /* Screens */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .screen.active {
            display: flex;
        }

        /* Inputs and Buttons */
        input[type="text"], input[type="number"] {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            background: #0f3460;
            color: white;
            text-align: center;
        }

        input[type="text"]::placeholder {
            color: #888;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 200px;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 0 30px rgba(233, 69, 96, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4ecca3 0%, #45b7aa 100%);
            color: #1a1a2e;
        }

        .btn-secondary:hover {
            box-shadow: 0 0 30px rgba(78, 204, 163, 0.6);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 1rem;
            min-width: auto;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Mode Selection */
        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }

        .mode-btn {
            padding: 30px 40px;
            font-size: 1.3rem;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .mode-btn .icon {
            font-size: 3rem;
        }

        .mode-btn .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Word List Editor */
        .word-list-editor {
            width: 100%;
            max-width: 400px;
            background: #0f3460;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: #1a1a2e;
            border-radius: 8px;
        }

        .word-item span {
            flex: 1;
            text-align: left;
        }

        .word-item button {
            background: #e94560;
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
        }

        .add-word-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-word-row input {
            flex: 1;
            padding: 10px;
            font-size: 1rem;
        }

        .add-word-row button {
            padding: 10px 20px;
            background: #4ecca3;
            border: none;
            border-radius: 10px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
        }

        /* Room Code Display */
        .room-code {
            background: #0f3460;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 2.5rem;
            letter-spacing: 10px;
            font-weight: bold;
            color: #4ecca3;
            border: 2px solid #4ecca3;
        }

        /* Player List */
        .player-list {
            width: 100%;
            max-width: 300px;
            background: #0f3460;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
        }

        .player-list h3 {
            margin-bottom: 15px;
            color: #4ecca3;
        }

        .player-item {
            padding: 10px;
            margin: 5px 0;
            background: #1a1a2e;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-item.host::before {
            content: 'üëë';
        }

        .player-item.you {
            border: 2px solid #4ecca3;
        }

        /* Role Reveal */
        .role-card {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a5e 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            border: 3px solid #e94560;
            min-width: 280px;
        }

        .role-card.imposter {
            border-color: #e94560;
            box-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
        }

        .role-card.crewmate {
            border-color: #4ecca3;
            box-shadow: 0 0 30px rgba(78, 204, 163, 0.5);
        }

        .role-label {
            font-size: 1rem;
            color: #888;
            margin-bottom: 10px;
        }

        .role-text {
            font-size: 2rem;
            font-weight: bold;
        }

        .role-card.imposter .role-text {
            color: #e94560;
        }

        .role-card.crewmate .role-text {
            color: #4ecca3;
        }

        /* Status Messages */
        .status {
            color: #888;
            font-size: 1rem;
            margin: 10px 0;
        }

        .status.waiting {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Error Messages */
        .error {
            color: #e94560;
            font-size: 1rem;
            margin: 10px 0;
        }

        /* Divider */
        .divider {
            width: 100%;
            height: 1px;
            background: #333;
            margin: 20px 0;
        }

        .or-text {
            color: #666;
            margin: 10px 0;
        }

        /* Ready indicator */
        .ready-status {
            margin-top: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 10px;
        }

        .ready-count {
            font-size: 1.2rem;
            color: #4ecca3;
        }

        /* Single Device Mode Styles */
        .player-boxes {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .player-box {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #0f3460 0%, #1a1a5e 100%);
            border: 3px solid #e94560;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .player-box:hover:not(.revealed) {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.6);
        }

        .player-box.revealed {
            background: #333;
            border-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #e94560;
            max-width: 90%;
        }

        .modal .role-text {
            font-size: 2.5rem;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .modal .role-text.imposter {
            color: #e94560;
            text-shadow: 0 0 20px rgba(233, 69, 96, 0.8);
        }

        .modal .role-text.crewmate {
            color: #4ecca3;
            text-shadow: 0 0 20px rgba(78, 204, 163, 0.8);
        }

        /* End Buttons */
        .end-buttons {
            display: none;
            margin-top: 30px;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .button-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Settings icon */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0f3460;
            border: 2px solid #4ecca3;
            color: #4ecca3;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
        }

        .settings-btn:hover {
            background: #4ecca3;
            color: #0f3460;
        }

        /* Back button */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #0f3460;
            border: 2px solid #e94560;
            color: #e94560;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
        }

        .back-btn:hover {
            background: #e94560;
            color: white;
        }

        .instructions {
            color: #888;
            font-size: 0.9rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Settings Button -->
    <button class="settings-btn" onclick="showWordEditor()" title="Edit Word List">‚öôÔ∏è</button>

    <div class="container">
        
        <!-- Screen 0: Mode Selection -->
        <div class="screen active" id="modeScreen">
            <h1>üé≠ IMPOSTER</h1>
            <p style="color: #888; margin-bottom: 20px;">Choose your game mode</p>
            <div class="mode-buttons">
                <button class="btn btn-primary mode-btn" onclick="selectMode('single')">
                    <span class="icon">üì±</span>
                    <span>One Device</span>
                    <span class="subtitle">Pass the phone around</span>
                </button>
                <button class="btn btn-secondary mode-btn" onclick="selectMode('multi')">
                    <span class="icon">üì±üì±üì±</span>
                    <span>Multiple Devices</span>
                    <span class="subtitle">Everyone uses their own phone</span>
                </button>
            </div>
        </div>

        <!-- Screen: Word List Editor -->
        <div class="screen" id="wordEditorScreen">
            <button class="back-btn" onclick="goBackFromEditor()">‚Üê</button>
            <h1>üìù Word List</h1>
            <p style="color: #888;">Edit the words that players will see</p>
            <div class="word-list-editor" id="wordListEditor"></div>
            <div class="add-word-row">
                <input type="text" id="newWordInput" placeholder="Add new word...">
                <button onclick="addWord()">Add</button>
            </div>
            <div class="button-row" style="margin-top: 20px;">
                <button class="btn btn-secondary btn-small" onclick="resetWords()">Reset to Default</button>
                <button class="btn btn-primary btn-small" onclick="goBackFromEditor()">Done</button>
            </div>
        </div>

        <!-- ==================== SINGLE DEVICE MODE ==================== -->
        
        <!-- Single Device: Lobby -->
        <div class="screen" id="singleLobbyScreen">
            <button class="back-btn" onclick="backToModeSelect()">‚Üê</button>
            <h1>üé≠ ONE DEVICE</h1>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                <label for="singlePlayerCount" style="font-size: 1.2rem;">Number of Players:</label>
                <input type="number" id="singlePlayerCount" min="3" max="20" value="4" style="width: 100px; height: 60px; font-size: 2rem;">
            </div>
            <button class="btn btn-primary" onclick="startSingleGame()">PLAY</button>
            <p class="instructions">Each player taps a box to see their role.<br>One person is the IMPOSTER!</p>
        </div>

        <!-- Single Device: Game -->
        <div class="screen" id="singleGameScreen">
            <h1>üé≠ Tap Your Box!</h1>
            <div class="player-boxes" id="singlePlayerBoxes"></div>
            <div class="end-buttons" id="singleEndButtons">
                <button class="btn btn-secondary" onclick="newSingleRound()">New Round</button>
                <button class="btn btn-primary" onclick="backToSingleLobby()">Back to Lobby</button>
            </div>
        </div>

        <!-- Single Device: Modal -->
        <div class="modal" id="singleModal">
            <div class="modal-content">
                <div class="role-text" id="singleRoleText"></div>
                <button class="btn btn-secondary" onclick="closeSingleModal()">OK</button>
            </div>
        </div>

        <!-- ==================== MULTI DEVICE MODE ==================== -->

        <!-- Multi Device: Menu -->
        <div class="screen" id="multiMenuScreen">
            <button class="back-btn" onclick="backToModeSelect()">‚Üê</button>
            <h1>üé≠ MULTIPLAYER</h1>
            <input type="text" id="playerName" placeholder="Enter your name" maxlength="15">
            <button class="btn btn-primary" onclick="createRoom()">Create Room</button>
            <div class="or-text">‚Äî or ‚Äî</div>
            <input type="text" id="joinCode" placeholder="Enter room code" maxlength="6" style="text-transform: uppercase;">
            <button class="btn btn-secondary" onclick="joinRoom()">Join Room</button>
            <p class="error" id="menuError"></p>
        </div>

        <!-- Multi Device: Lobby -->
        <div class="screen" id="multiLobbyScreen">
            <h1>üé≠ LOBBY</h1>
            <p>Room Code:</p>
            <div class="room-code" id="displayRoomCode">----</div>
            <div class="player-list">
                <h3>Players</h3>
                <div id="playerListContainer"></div>
            </div>
            <button class="btn btn-primary" id="startGameBtn" onclick="startMultiGame()" style="display: none;">Start Game</button>
            <p class="status waiting" id="lobbyStatus">Waiting for host to start...</p>
            <button class="btn btn-secondary btn-small" onclick="leaveRoom()" style="margin-top: 20px;">Leave Room</button>
        </div>

        <!-- Multi Device: Game (Role Reveal) -->
        <div class="screen" id="multiGameScreen">
            <h1>üé≠ YOUR ROLE</h1>
            <div class="role-card" id="roleCard">
                <div class="role-label">You are:</div>
                <div class="role-text" id="multiRoleText">Loading...</div>
            </div>
            <div class="player-list">
                <h3>Players in Game</h3>
                <div id="gamePlayerList"></div>
            </div>
            <div class="ready-status">
                <div class="ready-count" id="readyCount">0/0 players ready</div>
            </div>
            <button class="btn btn-secondary" id="readyBtn" onclick="markReady()">I'm Ready</button>
        </div>

        <!-- Multi Device: Round End -->
        <div class="screen" id="multiEndScreen">
            <h1>üé≠ ROUND OVER</h1>
            <p>Discuss and find the imposter!</p>
            <div class="player-list">
                <h3>Players</h3>
                <div id="endPlayerList"></div>
            </div>
            <button class="btn btn-secondary" id="newRoundBtn" onclick="newMultiRound()" style="display: none;">New Round</button>
            <button class="btn btn-primary" id="backToLobbyBtn" onclick="backToMultiLobby()" style="display: none;">Back to Lobby</button>
            <p class="status waiting" id="endStatus">Waiting for host...</p>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIG
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAOsYfd3vBVUzHqysG_oXPKi7yXrI-hVrE",
            authDomain: "imposter-game-777f3.firebaseapp.com",
            databaseURL: "https://imposter-game-777f3-default-rtdb.firebaseio.com",
            projectId: "imposter-game-777f3",
            storageBucket: "imposter-game-777f3.firebasestorage.app",
            messagingSenderId: "791197389028",
            appId: "1:791197389028:web:72282811d5e08040a7dcf1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ============================================
        // WORD LIST MANAGEMENT
        // ============================================
        const defaultWords = [
            "Charlie Kirk", "Diddy", "Butt Things", "LeBron James", "67",
            "Isreal", "Hitler", "Netanyahu", "JD Vance", "Trump", "Kanye",
            "Adrian", "Tum Tum tum Sahuuurrrr", "Yuno Myles", "Stay tuned burger",
            "Minorities", "John Pork", "Jews"
        ];

        let words = [...defaultWords];
        let previousScreen = 'modeScreen';
        let currentMode = null;

        // Load words from localStorage
        function loadWords() {
            const saved = localStorage.getItem('imposterWords');
            if (saved) {
                words = JSON.parse(saved);
            }
        }

        // Save words to localStorage
        function saveWords() {
            localStorage.setItem('imposterWords', JSON.stringify(words));
        }

        // Render word list editor
        function renderWordList() {
            const container = document.getElementById('wordListEditor');
            container.innerHTML = '';
            words.forEach((word, index) => {
                const div = document.createElement('div');
                div.className = 'word-item';
                div.innerHTML = `
                    <span>${word}</span>
                    <button onclick="removeWord(${index})">√ó</button>
                `;
                container.appendChild(div);
            });
        }

        // Add a new word
        function addWord() {
            const input = document.getElementById('newWordInput');
            const word = input.value.trim();
            if (word && !words.includes(word)) {
                words.push(word);
                saveWords();
                renderWordList();
                input.value = '';
            }
        }

        // Remove a word
        function removeWord(index) {
            words.splice(index, 1);
            saveWords();
            renderWordList();
        }

        // Reset to default words
        function resetWords() {
            if (confirm('Reset to default word list?')) {
                words = [...defaultWords];
                saveWords();
                renderWordList();
            }
        }

        // Show word editor
        function showWordEditor() {
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                previousScreen = activeScreen.id;
            }
            renderWordList();
            showScreen('wordEditorScreen');
        }

        // Go back from editor
        function goBackFromEditor() {
            showScreen(previousScreen);
        }

        // Handle enter key in word input
        document.addEventListener('DOMContentLoaded', () => {
            loadWords();
            document.getElementById('newWordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addWord();
            });
        });

        // ============================================
        // MODE SELECTION
        // ============================================
        function selectMode(mode) {
            currentMode = mode;
            if (mode === 'single') {
                showScreen('singleLobbyScreen');
            } else {
                showScreen('multiMenuScreen');
            }
        }

        function backToModeSelect() {
            if (roomRef && playerId) {
                leaveRoom();
            }
            showScreen('modeScreen');
        }

        // ============================================
        // SCREEN MANAGEMENT
        // ============================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // Show/hide back button based on screen
            const backBtns = document.querySelectorAll('.back-btn');
            backBtns.forEach(btn => btn.style.display = 'none');
            
            const currentScreenEl = document.getElementById(screenId);
            const backBtn = currentScreenEl.querySelector('.back-btn');
            if (backBtn) backBtn.style.display = 'block';
        }

        // ============================================
        // SINGLE DEVICE MODE
        // ============================================
        let singlePlayerCount = 4;
        let singleImposterIndex = 0;
        let singleCurrentWord = "";
        let singleRevealedCount = 0;
        let singleCurrentBoxIndex = -1;

        function startSingleGame() {
            singlePlayerCount = parseInt(document.getElementById('singlePlayerCount').value);
            if (singlePlayerCount < 3) singlePlayerCount = 3;
            if (singlePlayerCount > 20) singlePlayerCount = 20;
            
            setupSingleRound();
            showScreen('singleGameScreen');
        }

        function setupSingleRound() {
            singleImposterIndex = Math.floor(Math.random() * singlePlayerCount);
            singleCurrentWord = words[Math.floor(Math.random() * words.length)];
            singleRevealedCount = 0;

            const boxesContainer = document.getElementById('singlePlayerBoxes');
            boxesContainer.innerHTML = '';

            for (let i = 0; i < singlePlayerCount; i++) {
                const box = document.createElement('div');
                box.className = 'player-box';
                box.textContent = `P${i + 1}`;
                box.onclick = () => revealSingleRole(i);
                boxesContainer.appendChild(box);
            }

            document.getElementById('singleEndButtons').style.display = 'none';
        }

        function revealSingleRole(index) {
            const boxes = document.querySelectorAll('#singlePlayerBoxes .player-box');
            if (boxes[index].classList.contains('revealed')) return;

            singleCurrentBoxIndex = index;

            const roleText = document.getElementById('singleRoleText');
            if (index === singleImposterIndex) {
                roleText.textContent = "IMPOSTER";
                roleText.className = 'role-text imposter';
            } else {
                roleText.textContent = singleCurrentWord;
                roleText.className = 'role-text crewmate';
            }

            document.getElementById('singleModal').style.display = 'flex';
        }

        function closeSingleModal() {
            document.getElementById('singleModal').style.display = 'none';

            const boxes = document.querySelectorAll('#singlePlayerBoxes .player-box');
            boxes[singleCurrentBoxIndex].classList.add('revealed');
            boxes[singleCurrentBoxIndex].textContent = '‚úì';

            singleRevealedCount++;

            if (singleRevealedCount === singlePlayerCount) {
                document.getElementById('singleEndButtons').style.display = 'flex';
            }
        }

        function newSingleRound() {
            setupSingleRound();
        }

        function backToSingleLobby() {
            showScreen('singleLobbyScreen');
        }

        // ============================================
        // MULTI DEVICE MODE
        // ============================================
        let playerId = null;
        let playerName = '';
        let roomCode = null;
        let isHost = false;
        let roomRef = null;
        let currentScreen = 'multiMenuScreen';

        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substr(2, 9);
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function createRoom() {
            playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                document.getElementById('menuError').textContent = 'Please enter your name!';
                return;
            }

            playerId = generatePlayerId();
            roomCode = generateRoomCode();
            isHost = true;

            roomRef = db.ref('rooms/' + roomCode);

            const snapshot = await roomRef.once('value');
            if (snapshot.exists()) {
                roomCode = generateRoomCode();
                roomRef = db.ref('rooms/' + roomCode);
            }

            await roomRef.set({
                host: playerId,
                status: 'lobby',
                players: {
                    [playerId]: {
                        name: playerName,
                        isHost: true,
                        ready: false
                    }
                },
                gameData: null,
                words: words,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });

            roomRef.child('players/' + playerId).onDisconnect().remove();

            setupRoomListeners();

            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('startGameBtn').style.display = 'block';
            document.getElementById('lobbyStatus').style.display = 'none';
            showScreen('multiLobbyScreen');
            currentScreen = 'multiLobbyScreen';
        }

        async function joinRoom() {
            playerName = document.getElementById('playerName').value.trim();
            const code = document.getElementById('joinCode').value.trim().toUpperCase();

            if (!playerName) {
                document.getElementById('menuError').textContent = 'Please enter your name!';
                return;
            }
            if (!code || code.length !== 4) {
                document.getElementById('menuError').textContent = 'Please enter a valid 4-letter room code!';
                return;
            }

            roomCode = code;
            roomRef = db.ref('rooms/' + roomCode);

            const snapshot = await roomRef.once('value');
            if (!snapshot.exists()) {
                document.getElementById('menuError').textContent = 'Room not found!';
                return;
            }

            const roomData = snapshot.val();
            if (roomData.status !== 'lobby') {
                document.getElementById('menuError').textContent = 'Game already in progress!';
                return;
            }

            playerId = generatePlayerId();
            isHost = false;

            await roomRef.child('players/' + playerId).set({
                name: playerName,
                isHost: false,
                ready: false
            });

            roomRef.child('players/' + playerId).onDisconnect().remove();

            setupRoomListeners();

            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('startGameBtn').style.display = 'none';
            document.getElementById('lobbyStatus').style.display = 'block';
            showScreen('multiLobbyScreen');
            currentScreen = 'multiLobbyScreen';
        }

        function setupRoomListeners() {
            roomRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('Room was closed!');
                    showScreen('multiMenuScreen');
                    currentScreen = 'multiMenuScreen';
                    return;
                }

                const data = snapshot.val();
                updatePlayerList(data.players);

                if (data.host === playerId) {
                    isHost = true;
                }

                if (data.status === 'playing' && currentScreen === 'multiLobbyScreen') {
                    showMultiGameScreen(data);
                } else if (data.status === 'reveal' && currentScreen === 'multiGameScreen') {
                    showMultiEndScreen(data);
                } else if (data.status === 'lobby' && currentScreen === 'multiEndScreen') {
                    showMultiLobbyFromEnd(data);
                }

                if (currentScreen === 'multiGameScreen' && data.gameData) {
                    updateReadyCount(data.players);
                }

                if (currentScreen === 'multiEndScreen') {
                    updateEndScreenButtons();
                }
            });
        }

        function updatePlayerList(players) {
            const containers = ['playerListContainer', 'gamePlayerList', 'endPlayerList'];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                for (const [id, player] of Object.entries(players || {})) {
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    if (player.isHost) div.classList.add('host');
                    if (id === playerId) div.classList.add('you');
                    div.textContent = player.name + (id === playerId ? ' (You)' : '');
                    container.appendChild(div);
                }
            });

            const playerCount = Object.keys(players || {}).length;
            const startBtn = document.getElementById('startGameBtn');
            if (startBtn && isHost) {
                startBtn.disabled = playerCount < 3;
                startBtn.textContent = playerCount < 3 ? 'Need 3+ Players' : 'Start Game';
            }
        }

        async function startMultiGame() {
            if (!isHost) return;

            const snapshot = await roomRef.once('value');
            const data = snapshot.val();
            const playerIds = Object.keys(data.players);

            if (playerIds.length < 3) {
                alert('Need at least 3 players!');
                return;
            }

            const imposterIndex = Math.floor(Math.random() * playerIds.length);
            const imposterId = playerIds[imposterIndex];

            const gameWords = data.words || words;
            const word = gameWords[Math.floor(Math.random() * gameWords.length)];

            const roles = {};
            playerIds.forEach((id) => {
                roles[id] = {
                    isImposter: id === imposterId,
                    word: id === imposterId ? null : word
                };
            });

            const updates = {};
            playerIds.forEach(id => {
                updates['players/' + id + '/ready'] = false;
            });
            updates['gameData'] = { roles, word };
            updates['status'] = 'playing';

            await roomRef.update(updates);
        }

        function showMultiGameScreen(data) {
            const myRole = data.gameData.roles[playerId];
            const roleCard = document.getElementById('roleCard');
            const roleText = document.getElementById('multiRoleText');

            if (myRole.isImposter) {
                roleCard.className = 'role-card imposter';
                roleText.textContent = 'IMPOSTER';
            } else {
                roleCard.className = 'role-card crewmate';
                roleText.textContent = myRole.word;
            }

            document.getElementById('readyBtn').disabled = false;
            document.getElementById('readyBtn').textContent = "I'm Ready";
            
            showScreen('multiGameScreen');
            currentScreen = 'multiGameScreen';
        }

        async function markReady() {
            await roomRef.child('players/' + playerId + '/ready').set(true);
            document.getElementById('readyBtn').disabled = true;
            document.getElementById('readyBtn').textContent = 'Waiting...';
        }

        function updateReadyCount(players) {
            const total = Object.keys(players).length;
            const ready = Object.values(players).filter(p => p.ready).length;
            document.getElementById('readyCount').textContent = `${ready}/${total} players ready`;

            if (ready === total && isHost) {
                roomRef.update({ status: 'reveal' });
            }
        }

        function showMultiEndScreen(data) {
            updateEndScreenButtons();
            showScreen('multiEndScreen');
            currentScreen = 'multiEndScreen';
        }

        function updateEndScreenButtons() {
            if (isHost) {
                document.getElementById('newRoundBtn').style.display = 'block';
                document.getElementById('backToLobbyBtn').style.display = 'block';
                document.getElementById('endStatus').style.display = 'none';
            } else {
                document.getElementById('newRoundBtn').style.display = 'none';
                document.getElementById('backToLobbyBtn').style.display = 'none';
                document.getElementById('endStatus').style.display = 'block';
            }
        }

        async function newMultiRound() {
            if (!isHost) return;

            const snapshot = await roomRef.once('value');
            const data = snapshot.val();
            const playerIds = Object.keys(data.players);

            const imposterIndex = Math.floor(Math.random() * playerIds.length);
            const imposterId = playerIds[imposterIndex];

            const gameWords = data.words || words;
            const word = gameWords[Math.floor(Math.random() * gameWords.length)];

            const roles = {};
            playerIds.forEach(id => {
                roles[id] = {
                    isImposter: id === imposterId,
                    word: id === imposterId ? null : word
                };
            });

            const updates = {};
            playerIds.forEach(id => {
                updates['players/' + id + '/ready'] = false;
            });
            updates['gameData'] = { roles, word };
            updates['status'] = 'playing';

            await roomRef.update(updates);
        }

        async function backToMultiLobby() {
            if (!isHost) return;

            const snapshot = await roomRef.once('value');
            const data = snapshot.val();
            const playerIds = Object.keys(data.players);

            const updates = {};
            playerIds.forEach(id => {
                updates['players/' + id + '/ready'] = false;
            });
            updates['gameData'] = null;
            updates['status'] = 'lobby';

            await roomRef.update(updates);
        }

        function showMultiLobbyFromEnd(data) {
            document.getElementById('displayRoomCode').textContent = roomCode;
            if (isHost) {
                document.getElementById('startGameBtn').style.display = 'block';
                document.getElementById('lobbyStatus').style.display = 'none';
            } else {
                document.getElementById('startGameBtn').style.display = 'none';
                document.getElementById('lobbyStatus').style.display = 'block';
            }
            showScreen('multiLobbyScreen');
            currentScreen = 'multiLobbyScreen';
        }

        async function leaveRoom() {
            if (roomRef && playerId) {
                await roomRef.child('players/' + playerId).remove();
                
                if (isHost) {
                    const snapshot = await roomRef.child('players').once('value');
                    const players = snapshot.val();
                    if (players) {
                        const newHostId = Object.keys(players)[0];
                        await roomRef.update({
                            host: newHostId,
                            ['players/' + newHostId + '/isHost']: true
                        });
                    } else {
                        await roomRef.remove();
                    }
                }
            }
            
            playerId = null;
            roomCode = null;
            isHost = false;
            roomRef = null;
            
            document.getElementById('menuError').textContent = '';
            document.getElementById('playerName').value = '';
            document.getElementById('joinCode').value = '';
            
            showScreen('modeScreen');
            currentScreen = 'multiMenuScreen';
        }

        // Auto-uppercase room code input
        document.getElementById('joinCode').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    </script>
</body>
</html>
